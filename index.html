<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MilBudget</title>
  <meta name="description" content="MilBudget - simple money control for Soldiers & families." />

  <style>
    :root{
      --bg:#0b1220;
      --bg2:#070c16;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.09);
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.93);
      --muted:rgba(255,255,255,.67);
      --muted2:rgba(255,255,255,.5);
      --good:rgba(70,255,175,.92);
      --bad:rgba(255,95,95,.96);
      --warn:rgba(255,208,112,.95);
      --brand:rgba(110,168,255,.98);
      --shadow: 0 18px 42px rgba(0,0,0,.5);
      --radius:18px;
      --radius2:22px;

      --btn: rgba(110,168,255,.16);
      --btnstroke: rgba(110,168,255,.45);

      --chip: rgba(255,255,255,.07);
      --chipstroke: rgba(255,255,255,.14);

      --gridgap: 14px;

      --navh: 72px;
    }

    [data-theme="light"]{
      --bg:#f5f7ff;
      --bg2:#eef2ff;
      --panel:rgba(0,0,0,.05);
      --panel2:rgba(0,0,0,.07);
      --stroke:rgba(0,0,0,.12);
      --text:rgba(0,0,0,.88);
      --muted:rgba(0,0,0,.62);
      --muted2:rgba(0,0,0,.46);
      --shadow: 0 18px 42px rgba(0,0,0,.18);
      --btn: rgba(110,168,255,.22);
      --btnstroke: rgba(110,168,255,.50);
      --chip: rgba(0,0,0,.04);
      --chipstroke: rgba(0,0,0,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1000px 520px at 18% -10%, rgba(110,168,255,.26), transparent 70%),
        radial-gradient(900px 520px at 92% 10%, rgba(70,255,175,.18), transparent 70%),
        radial-gradient(760px 520px at 50% 120%, rgba(255,95,95,.16), transparent 70%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      min-height:100vh;
    }

    /* App shell */
    .app{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* Top nav (NerdWallet vibe) */
    .topNavWrap{
      position:sticky; top:0; z-index:55;
      backdrop-filter: blur(14px);
      background: rgba(0,0,0,.22);
      border-bottom:1px solid var(--stroke);
    }
    [data-theme="light"] .topNavWrap{
      background: rgba(255,255,255,.82);
    }

    .topStripe{
      height: 10px;
      background:
        linear-gradient(90deg,
          rgba(110,168,255,.95),
          rgba(70,255,175,.90),
          rgba(255,208,112,.88),
          rgba(110,168,255,.95)
        );
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    [data-theme="light"] .topStripe{ border-bottom-color: rgba(0,0,0,.10); }

    .topNav{
      height: var(--navh);
      max-width: 1180px;
      margin: 0 auto;
      padding: 10px 16px;
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brandLink{
      display:flex;
      gap:10px;
      align-items:center;
      text-decoration:none;
      color:inherit;
      padding:10px 10px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: var(--panel);
      box-shadow: var(--shadow);
      transition: .15s transform, .15s background;
      white-space:nowrap;
    }
    .brandLink:hover{ transform: translateY(-1px); background: var(--panel2); }
    .logo{
      width:38px; height:38px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(110,168,255,.98), rgba(70,255,175,.88));
      display:grid; place-items:center;
      font-weight:950;
      color: rgba(0,0,0,.78);
      letter-spacing:-.02em;
      flex:0 0 auto;
    }
    .brandText{ display:flex; flex-direction:column; line-height:1.05; }
    .brandText b{ font-size:14px; letter-spacing:-.02em; }
    .brandText span{ font-size:11px; color: var(--muted); margin-top:2px; }

    .tabs{
      flex:1;
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .tabBtn{
      border:1px solid var(--stroke);
      background: transparent;
      color: var(--muted);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:850;
      font-size:12px;
      letter-spacing:-.01em;
      transition:.15s transform, .15s background, .15s border, .15s color;
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .tabBtn:hover{ transform: translateY(-1px); background: var(--panel); color: var(--text); }
    .tabBtn.active{
      border-color: rgba(110,168,255,.62);
      background: rgba(110,168,255,.14);
      color: var(--text);
    }

    .navRight{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 10px;
      border-radius:999px;
      border:1px solid var(--chipstroke);
      background: var(--chip);
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius:99px;
      background: rgba(255,255,255,.25);
      border: 1px solid rgba(255,255,255,.18);
    }
    .dot.good{background: var(--good); border-color: rgba(0,0,0,.1)}
    .dot.warn{background: var(--warn); border-color: rgba(0,0,0,.1)}
    .dot.bad{background: var(--bad); border-color: rgba(0,0,0,.1)}

    .btn{
      border:1px solid var(--btnstroke);
      background: var(--btn);
      color: var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.15s transform, .15s background;
      font-weight:900;
      font-size:12px;
      letter-spacing:-.01em;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(110,168,255,.24) }
    .btn.secondary{
      border:1px solid var(--stroke);
      background: var(--panel);
      font-weight:850;
    }
    .btn.danger{
      border-color: rgba(255,95,95,.55);
      background: rgba(255,95,95,.12);
    }
    .btn.small{ padding:8px 10px; border-radius:12px; }

    .main{
      max-width: 1180px;
      width:100%;
      margin: 0 auto;
      padding: 18px 16px 22px;
    }

    /* Sections */
    .section{ display:none }
    .section.active{ display:block }

    /* Cards/grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--gridgap);
    }
    .card{
      border:1px solid var(--stroke);
      background:var(--panel);
      border-radius:var(--radius2);
      padding:14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .card h3{
      margin:0 0 10px;
      font-size:13px;
      color:var(--muted);
      font-weight:850;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }

    .metric{
      font-size:28px;
      font-weight:950;
      letter-spacing:-.03em;
    }
    .metric.good{ color: var(--good) }
    .metric.bad{ color: var(--bad) }

    .muted{ color:var(--muted); font-size:13px; line-height:1.35 }
    .muted2{ color:var(--muted2); font-size:12px; line-height:1.35 }

    .row{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:flex-end;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:7px;
      flex:1;
      min-width: 180px;
    }
    label{ font-size:12px; color:var(--muted); font-weight:850 }
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    [data-theme="light"] input,
    [data-theme="light"] select,
    [data-theme="light"] textarea{
      background: rgba(255,255,255,.72);
    }
    textarea{ min-height: 88px; resize: vertical; }

    .progress{
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    [data-theme="light"] .progress{
      background: rgba(0,0,0,.06);
      border-color: rgba(0,0,0,.10);
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(110,168,255,.98), rgba(70,255,175,.92));
    }

    .kpiRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .kpi{
      flex:1; min-width: 170px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    [data-theme="light"] .kpi{ background: rgba(0,0,0,.04); border-color: rgba(0,0,0,.10); }
    .kpi .t{ color:var(--muted); font-size:12px; font-weight:900; }
    .kpi .v{ font-weight:950; font-size:18px; margin-top:4px; letter-spacing:-.02em }

    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.14);
    }
    [data-theme="light"] .table{ background: rgba(255,255,255,.70); }
    .table th, .table td{
      padding:11px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-align:left;
      font-size:13px;
      vertical-align:middle;
    }
    [data-theme="light"] .table th, [data-theme="light"] .table td{ border-bottom-color: rgba(0,0,0,.08); }
    .table th{
      color:var(--muted);
      font-weight:950;
      font-size:12px;
      letter-spacing:.01em;
    }
    .table tr:last-child td{ border-bottom:none; }

    .tagBtn{
      border:1px solid var(--chipstroke);
      background: var(--chip);
      color: var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      gap:6px;
      align-items:center;
      white-space:nowrap;
      transition:.15s transform, .15s background;
      user-select:none;
    }
    .tagBtn:hover{ transform: translateY(-1px); background: var(--panel2); }

    .divider{ height:1px; background: rgba(255,255,255,.10); margin:12px 0; }
    [data-theme="light"] .divider{ background: rgba(0,0,0,.10); }

    /* Toast */
    .toast{
      position:fixed;
      right:16px;
      bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.55);
      color:var(--text);
      box-shadow: var(--shadow);
      opacity:0;
      transform: translateY(10px);
      transition: .2s;
      max-width: 360px;
      pointer-events:none;
      font-size:13px;
      z-index: 80;
    }
    [data-theme="light"] .toast{ background: rgba(255,255,255,.88); }
    .toast.show{ opacity:1; transform: translateY(0) }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:90;
    }
    .modal{
      width:min(820px, 100%);
      border-radius:22px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding:14px;
    }
    [data-theme="light"] .modal{ background: rgba(255,255,255,.92); }
    .modalHeader{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:8px 8px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      margin-bottom:12px;
    }
    [data-theme="light"] .modalHeader{ border-bottom-color: rgba(0,0,0,.10); }
    .modalHeader h3{ margin:0; color: var(--text); font-size:15px; font-weight:950; }
    .modalBody{ padding: 0 8px 8px; }
    .modalActions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; padding: 8px; }

    canvas{ width:100%; height:180px; display:block; }

    /* Mobile bottom nav stays */
    .mobileNav{
      display:none;
      position:fixed;
      left:12px; right:12px;
      bottom: calc(12px + env(safe-area-inset-bottom, 0px));
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      border-radius:18px;
      padding:10px;
      gap:10px;
      z-index:70;
    }
    [data-theme="light"] .mobileNav{ background: rgba(255,255,255,.85); }
    .mobileNav button{
      flex:1;
      border:1px solid var(--stroke);
      background: var(--panel);
      color: var(--text);
      padding:12px 10px;
      border-radius:14px;
      font-weight:950;
      font-size:12px;
      cursor:pointer;
    }
    .mobileNav button.active{ border-color: rgba(110,168,255,.62); background: rgba(110,168,255,.12) }

    /* Responsive */
    @media (max-width: 960px){
      .tabs{ display:none; } /* on mobile, keep it super clean; use bottom nav */
      .topNav{ padding: 10px 12px; }
      .brandText span{ display:none; }
      .main{ padding: 14px 12px 110px; }
      .grid{ gap:12px; }
      .card{ border-radius:20px; }
      .field{ min-width: 160px; }
      .mobileNav{ display:flex; }
    }
  </style>
</head>

<body>
  <div class="app" id="appRoot">
    <!-- TOP NAV -->
    <div class="topNavWrap">
      <div class="topStripe" aria-hidden="true"></div>
      <div class="topNav">
        <a class="brandLink" href="#" id="logoHome" title="Go to Dashboard">
          <div class="logo">MB</div>
          <div class="brandText">
            <b>MilBudget</b>
            <span>Simple money control</span>
          </div>
        </a>

        <div class="tabs" id="tabs">
          <button class="tabBtn active" data-tab="dashboard">üè† Dashboard</button>
          <button class="tabBtn" data-tab="pay">üóìÔ∏è Payday Split</button>
          <button class="tabBtn" data-tab="bills">üßæ Bills</button>
          <button class="tabBtn" data-tab="debts">üí≥ Debts</button>
          <button class="tabBtn" data-tab="goals">üéØ Goals</button>
          <button class="tabBtn" data-tab="profile">ü™ñ Pay Setup</button>
          <button class="tabBtn" data-tab="settings">‚öôÔ∏è Settings</button>
        </div>

        <div class="navRight">
          <div class="chip"><span class="dot" id="chipDot"></span><span id="chipStatus">Ready</span></div>
          <div class="chip" id="userChip">Guest</div>
          <button class="btn secondary small" id="btnTheme">üåì Theme</button>
          <button class="btn secondary small" id="btnLogin">üîê Login</button>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <main class="main">
      <!-- DASHBOARD -->
      <section id="dashboard" class="section active">
        <div class="row" style="justify-content:space-between;align-items:flex-start;margin-bottom:12px">
          <div>
            <div style="font-weight:950;font-size:22px;letter-spacing:-.02em">Dashboard</div>
            <div class="muted">Minimal overview. Add widgets only if you want them.</div>
          </div>
          <div class="row" style="align-items:center">
            <button class="btn secondary" id="btnCustomizeDash">‚ú® Customize</button>
            <button class="btn secondary" id="btnQuickTour">üß≠ Quick Tour</button>
          </div>
        </div>

        <!-- Essentials (always on) -->
        <div class="grid">
          <div class="card" style="grid-column: span 4;">
            <h3>Monthly Income <button class="tagBtn" id="goProfileFromDash">edit ‚Üí</button></h3>
            <div class="metric" id="mIncome">$0.00</div>
            <div class="muted2" id="incomeHint">Set income in Pay Setup.</div>
          </div>

          <div class="card" style="grid-column: span 4;">
            <h3>Total Bills <button class="tagBtn" id="goBillsFromDash">manage ‚Üí</button></h3>
            <div class="metric" id="mBills">$0.00</div>
            <div class="muted2" id="billHint">Add bills to tighten accuracy.</div>
          </div>

          <div class="card" style="grid-column: span 4;">
            <h3>Remaining <button class="tagBtn" id="goPayFromDash">split ‚Üí</button></h3>
            <div class="metric" id="mRemaining">$0.00</div>
            <div class="muted2">After bills + goals + debt payments.</div>
          </div>
        </div>

        <div style="height:14px"></div>

        <!-- Optional Widgets (toggle in Customize) -->
        <div class="grid" id="dashWidgets"></div>
      </section>

      <!-- PAYDAY SPLIT -->
      <section id="pay" class="section">
        <div class="card">
          <h3>Payday Split (1st / 15th)</h3>
          <div class="muted">
            Bills are auto-routed by due date: <b>Due day 1‚Äì14 ‚Üí Paycheck #1</b> and <b>Due day 15‚Äì31 ‚Üí Paycheck #2</b>.
          </div>

          <div style="height:12px"></div>

          <div class="kpiRow">
            <div class="kpi"><div class="t">Paycheck #1</div><div class="v" id="p1Income">$0.00</div></div>
            <div class="kpi"><div class="t">Paycheck #2</div><div class="v" id="p2Income">$0.00</div></div>
            <div class="kpi"><div class="t">Remaining combined</div><div class="v" id="pRemainCombined">$0.00</div></div>
          </div>

          <div style="height:14px"></div>

          <div class="grid">
            <div class="card" style="grid-column: span 6; box-shadow:none;">
              <h3>Paycheck #1 (1st)</h3>
              <div class="muted2">Due days 1‚Äì14 + half goals + half debt payments.</div>
              <div style="height:10px"></div>
              <table class="table">
                <thead><tr><th>Item</th><th>Type</th><th>Amount</th></tr></thead>
                <tbody id="p1Rows"></tbody>
              </table>
              <div class="divider"></div>
              <div class="kpiRow">
                <div class="kpi"><div class="t">Total out</div><div class="v" id="p1Out">$0.00</div></div>
                <div class="kpi"><div class="t">Leftover</div><div class="v" id="p1Left">$0.00</div></div>
              </div>
            </div>

            <div class="card" style="grid-column: span 6; box-shadow:none;">
              <h3>Paycheck #2 (15th)</h3>
              <div class="muted2">Due days 15‚Äì31 + half goals + half debt payments.</div>
              <div style="height:10px"></div>
              <table class="table">
                <thead><tr><th>Item</th><th>Type</th><th>Amount</th></tr></thead>
                <tbody id="p2Rows"></tbody>
              </table>
              <div class="divider"></div>
              <div class="kpiRow">
                <div class="kpi"><div class="t">Total out</div><div class="v" id="p2Out">$0.00</div></div>
                <div class="kpi"><div class="t">Leftover</div><div class="v" id="p2Left">$0.00</div></div>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>
          <div class="row">
            <button class="btn secondary" id="btnGoBills">üßæ Add/Adjust Bills</button>
            <button class="btn secondary" id="btnGoProfile2">ü™ñ Adjust Pay</button>
          </div>
        </div>
      </section>

      <!-- BILLS -->
      <section id="bills" class="section">
        <div class="card">
          <h3>Bills</h3>
          <div class="muted">Use the real due day (1‚Äì31). The app automatically routes it to paycheck #1 or #2.</div>

          <div style="height:10px"></div>

          <div class="row">
            <div class="field"><label>Bill name</label><input id="billName" placeholder="Rent, Car Payment, Phone..." /></div>
            <div class="field"><label>Amount</label><input id="billAmount" type="number" min="0" step="0.01" placeholder="975" /></div>
            <div class="field">
              <label>Due day (1‚Äì31)</label>
              <input id="billDueDay" type="number" min="1" max="31" step="1" placeholder="1" />
            </div>
            <div class="field">
              <label>Category</label>
              <select id="billCat">
                <option value="Housing">Housing</option>
                <option value="Transportation">Transportation</option>
                <option value="Insurance">Insurance</option>
                <option value="Utilities">Utilities</option>
                <option value="Subscriptions">Subscriptions</option>
                <option value="Phone/Internet">Phone/Internet</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="row">
            <button class="btn" id="addBill">‚ûï Add Bill</button>
            <button class="btn secondary" id="clearBillInputs">Clear</button>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="field"><label>Search</label><input id="billSearch" placeholder="Type to filter (rent, car, etc.)" /></div>
            <div class="field">
              <label>Sort</label>
              <select id="billSort">
                <option value="due">Due day</option>
                <option value="amountDesc">Amount (high ‚Üí low)</option>
                <option value="amountAsc">Amount (low ‚Üí high)</option>
                <option value="name">Name</option>
                <option value="cat">Category</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>

          <table class="table">
            <thead><tr><th>Bill</th><th>Category</th><th>Due</th><th>Routes to</th><th>Amount</th><th></th></tr></thead>
            <tbody id="billRows"></tbody>
          </table>

          <div class="muted2" style="margin-top:10px">
            Rule: due day 1‚Äì14 ‚Üí Paycheck #1 (1st). Due day 15‚Äì31 ‚Üí Paycheck #2 (15th).
          </div>
        </div>
      </section>

      <!-- DEBTS -->
      <section id="debts" class="section">
        <div class="card">
          <h3>Debts</h3>

          <div class="row">
            <div class="field"><label>Debt name</label><input id="debtName" placeholder="Camry Loan, Credit Card..." /></div>
            <div class="field"><label>Balance</label><input id="debtBal" type="number" min="0" step="0.01" placeholder="8000" /></div>
            <div class="field"><label>APR %</label><input id="debtApr" type="number" min="0" step="0.01" placeholder="6.00" /></div>
            <div class="field"><label>Monthly payment</label><input id="debtPay" type="number" min="0" step="0.01" placeholder="502" /></div>
          </div>

          <div style="height:10px"></div>
          <div class="row">
            <button class="btn" id="addDebt">‚ûï Add Debt</button>
            <button class="btn secondary" id="clearDebtInputs">Clear</button>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="field"><label>Extra monthly paydown</label><input id="extraDebt" type="number" min="0" step="0.01" placeholder="0" /></div>
            <div class="field">
              <label>Payoff strategy</label>
              <select id="debtStrategy">
                <option value="avalanche">Avalanche (highest APR)</option>
                <option value="snowball">Snowball (smallest balance)</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="kpiRow">
            <div class="kpi"><div class="t">Total debt</div><div class="v" id="debtTotal">$0.00</div></div>
            <div class="kpi"><div class="t">Total monthly payments</div><div class="v" id="debtMonthly">$0.00</div></div>
            <div class="kpi"><div class="t">Estimated payoff time</div><div class="v" id="debtPayoff">‚Äî</div></div>
          </div>

          <div style="height:12px"></div>

          <table class="table">
            <thead><tr><th>Debt</th><th>Balance</th><th>APR</th><th>Payment</th><th>Est. months</th><th></th></tr></thead>
            <tbody id="debtRows"></tbody>
          </table>

          <div class="muted2" style="margin-top:10px">
            Payoff estimates are approximate (good for planning).
          </div>
        </div>
      </section>

      <!-- GOALS -->
      <section id="goals" class="section">
        <div class="card">
          <h3>Goals</h3>

          <div class="row">
            <div class="field"><label>Emergency fund (monthly)</label><input id="gEmergency" type="number" min="0" step="0.01" placeholder="200" /></div>
            <div class="field"><label>Investing (monthly)</label><input id="gInvest" type="number" min="0" step="0.01" placeholder="100" /></div>
            <div class="field"><label>Fun money (monthly)</label><input id="gFun" type="number" min="0" step="0.01" placeholder="150" /></div>
            <div class="field"><label>Groceries (monthly)</label><input id="gGroc" type="number" min="0" step="0.01" placeholder="300" /></div>
          </div>

          <div style="height:10px"></div>
          <div class="row">
            <button class="btn" id="saveGoals">üíæ Save Goals</button>
            <button class="btn secondary" id="zeroGoals">Zero All</button>
          </div>

          <div class="divider"></div>

          <div class="kpiRow">
            <div class="kpi"><div class="t">Goals total</div><div class="v" id="goalsTotal">$0.00</div></div>
            <div class="kpi"><div class="t">Goals as % of income</div><div class="v" id="saveRate">‚Äî</div></div>
            <div class="kpi"><div class="t">Left after goals</div><div class="v" id="leftAfterGoals">$0.00</div></div>
          </div>
        </div>
      </section>

      <!-- PROFILE / PAY SETUP -->
      <section id="profile" class="section">
        <div class="card">
          <h3>Pay Setup</h3>
          <div class="muted">
            Main idea: set your <b>monthly take-home</b>. Optional: use the 2026 military helper to auto-fill <b>gross</b> (Base + BAS + BAH estimate).
            Manual edits are always allowed.
          </div>

          <div style="height:12px"></div>

          <div class="row">
            <div class="field">
              <label>Pay schedule</label>
              <select id="paySchedule">
                <option value="monthly">Monthly</option>
                <option value="1st15th">1st & 15th</option>
              </select>
            </div>
            <div class="field">
              <label>Your monthly take-home income (used everywhere)</label>
              <input id="incomeMonthly" type="number" min="0" step="0.01" placeholder="4200" />
            </div>
            <div class="field">
              <label>Spouse income included?</label>
              <select id="spouseEnabled">
                <option value="no">No</option>
                <option value="yes">Yes</option>
              </select>
            </div>
            <div class="field">
              <label>Spouse monthly take-home</label>
              <input id="spouseIncome" type="number" min="0" step="0.01" placeholder="0" />
            </div>
          </div>

          <div class="divider"></div>

          <h3>Military Pay Helper (Accurate 2026 tables) <span class="tagBtn" id="btnExplainPay">how it works ‚Üí</span></h3>

          <div class="row">
            <div class="field">
              <label>Rank</label>
              <select id="rank">
                <option value="">‚Äî Select ‚Äî</option>
                <option value="E1">E-1</option><option value="E2">E-2</option><option value="E3">E-3</option>
                <option value="E4">E-4</option><option value="E5">E-5</option><option value="E6">E-6</option>
                <option value="E7">E-7</option><option value="E8">E-8</option><option value="E9">E-9</option>
              </select>
            </div>
            <div class="field">
              <label>Years of service (whole years)</label>
              <input id="yos" type="number" min="0" max="40" step="1" placeholder="1" />
            </div>
            <div class="field">
              <label>Receive BAS?</label>
              <select id="basEnabled">
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
            <div class="field">
              <label>BAH (manual ‚Äî varies by zip)</label>
              <input id="bah" type="number" min="0" step="0.01" placeholder="0" />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <div class="field">
              <label>Base pay (auto, editable)</label>
              <input id="basePay" type="number" min="0" step="0.01" placeholder="0" />
            </div>
            <div class="field">
              <label>BAS (auto, editable)</label>
              <input id="bas" type="number" min="0" step="0.01" placeholder="0" />
            </div>
            <div class="field">
              <label>Calculated gross (Base + BAS + BAH)</label>
              <input id="calcTotal" disabled />
            </div>
            <div class="field">
              <label>Shortcut</label>
              <button class="btn secondary" id="btnUseCalcAsIncome">Use gross as take-home</button>
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="row">
            <button class="btn" id="applyRank">ü™ñ Auto-fill base + BAS (2026)</button>
            <button class="btn secondary" id="saveProfile">üíæ Save Pay Setup</button>
          </div>

          <div class="muted2" style="margin-top:10px">
            Tip: For real take-home, use your LES or myPay net amount. This helper is mainly to help new Soldiers estimate when they don‚Äôt know their pay yet.
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="settings" class="section">
        <div class="card">
          <h3>Settings</h3>

          <div class="row">
            <button class="btn secondary" id="btnExport">üì§ Export Data</button>
            <button class="btn secondary" id="btnImport">üì• Import Data</button>
            <button class="btn" id="btnDemo">‚ú® Load Demo Data</button>
            <button class="btn danger" id="btnWipe">üß® Wipe Everything</button>
            <button class="btn secondary" id="btnPrint">üñ®Ô∏è Print Summary</button>
          </div>

          <div class="divider"></div>

          <h3>Feedback Notes</h3>
          <textarea id="feedbackNotes" placeholder="Type what your friends say‚Ä¶ this saves here."></textarea>
        </div>
      </section>

      <div class="toast" id="toast"></div>
    </main>
  </div>

  <!-- Mobile Nav -->
  <div class="mobileNav" id="mobileNav">
    <button class="active" data-tab="dashboard">üè†</button>
    <button data-tab="pay">üóìÔ∏è</button>
    <button data-tab="bills">üßæ</button>
    <button data-tab="debts">üí≥</button>
    <button data-tab="profile">ü™ñ</button>
  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <h3 id="modalTitle">Modal</h3>
        <button class="btn secondary small" id="modalClose">‚úï</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalActions" id="modalActions"></div>
    </div>
  </div>

  <script>
    // ============
    // MilBudget v2.00 - minimalist dashboard + top tabs + real due dates + accurate 2026 base pay + BAS
    // ============

    const KEY = "milbudget_v200";
    const $ = (id)=>document.getElementById(id);
    const fmt = (n)=> (Number(n||0)).toLocaleString(undefined,{style:"currency", currency:"USD"});
    const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));
    const nowISO = ()=> new Date().toISOString();
    const escapeHtml = (str)=> String(str||"").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    const uuid = ()=> Math.random().toString(16).slice(2) + "-" + Math.random().toString(16).slice(2);

    // ---- Accurate 2026 BAS (monthly)
    const BAS_2026_ENLISTED = 476.95;   // DFAS 2026
    // Officers BAS is 328.48 but this app currently focuses enlisted ranks.

    // ---- Accurate 2026 Enlisted Base Pay (monthly) by grade + "Over X" year thresholds (DFAS table)
    // Threshold buckets from DFAS table columns: <=2, >2, >3, >4, >6, >8, >10, >12, >14, >16, >18, >20, >22, >24, >26, >28, >30, >32, >34, >36, >38, >40
    const YOS_THRESH = [0, 2, 3, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40];

    // Values taken from DFAS "Basic Pay ‚Äì Enlisted Effective January 1, 2026"
    // For ranks that flatline after a point, we repeat the last value across remaining buckets.
    const BASEPAY_2026 = {
      E1: [2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20,2407.20],
      E2: [2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90,2697.90],
      E3: [2836.80,3015.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00,3198.00],
      E4: [3142.20,3303.00,3482.40,3658.50,3815.40,3815.40,3815.40,3815.40,3815.40,3815.40,3815.40,3815.40,3815.40,3815.40,3815.40,3815.40,3815.40,3815.40,3815.40,3815.40,3815.40,3815.40],
      E5: [3342.90,3598.20,3775.80,3946.80,4110.00,4299.90,4395.30,4421.70,4421.70,4421.70,4421.70,4421.70,4421.70,4421.70,4421.70,4421.70,4421.70,4421.70,4421.70,4421.70,4421.70,4421.70],
      E6: [3401.10,3743.10,3908.10,4068.90,4235.70,4612.80,4759.50,5043.30,5130.30,5193.60,5267.70,5267.70,5267.70,5267.70,5267.70,5267.70,5267.70,5267.70,5267.70,5267.70,5267.70,5267.70],
      E7: [3932.10,4291.50,4456.20,4673.10,4843.80,5135.70,5300.40,5591.70,5835.00,6000.90,6177.30,6245.70,6475.20,6598.20,7067.40,7067.40,7067.40,7067.40,7067.40,7067.40,7067.40,7067.40],
      E8: [5656.50,5907.00,6061.80,6247.20,6448.20,6811.20,6995.40,7308.30,7481.70,7908.90,7908.90,8067.30,8067.30,8067.30,8067.30,8067.30,8067.30,8067.30,8067.30,8067.30,8067.30,8067.30],
      E9: [0,0,0,0,0,0,0,0,0,0,0,8105.10,8423.10,8756.70,9267.90,9267.90,9730.20,9730.20,10217.40,10217.40,10729.20,10729.20]
      // NOTE: The DFAS table has E-9 values starting at >18 bucket too, but DFAS page splits at 20+.
      // This app treats E9 as "20+ years" planning; if you need exact E9 18+ steps we can add those buckets.
    };

    function load(){
      try{ const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : null; }
      catch(e){ return null; }
    }

    const state = load() || {
      meta: { created: nowISO(), updated: nowISO() },
      theme: "dark",
      user: { name: "Guest" },
      feedbackNotes: "",
      notes: "",
      dashboardWidgets: {
        allocation: false,
        quickActions: false,
        visual: false,
        nextUp: false
      },
      profile: {
        paySchedule: "1st15th",
        monthlyIncome: 0,
        spouseEnabled: "no",
        spouseIncome: 0,
        rank: "",
        yos: 0,
        basEnabled: "yes",
        basePay: 0,
        bas: 0,
        bah: 0
      },
      bills: [],
      debts: [],
      goals: { emergency:0, invest:0, fun:0, groceries:0 },
      debtPlan: { extra:0, strategy:"avalanche" }
    };

    function save(){
      state.meta.updated = nowISO();
      localStorage.setItem(KEY, JSON.stringify(state));
      pulseSaved();
      updateUserChip();
    }

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1500);
    }

    function pulseSaved(){ /* minimal; keep silent */ }

    function setTheme(theme){
      state.theme = theme;
      document.documentElement.setAttribute("data-theme", theme === "light" ? "light" : "dark");
      save();
      toast(theme === "light" ? "Light mode" : "Dark mode");
      renderAll();
    }

    // Tabs / Navigation
    const sections = ["dashboard","pay","bills","debts","goals","profile","settings"];

    function setTab(tab){
      sections.forEach(id => $(id).classList.toggle("active", id===tab));
      document.querySelectorAll(".tabBtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
      document.querySelectorAll("#mobileNav button").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
      window.scrollTo({top:0, behavior:"smooth"});
      renderAll();
    }

    document.querySelectorAll(".tabBtn").forEach(b=>b.addEventListener("click", ()=>setTab(b.dataset.tab)));
    document.querySelectorAll("#mobileNav button").forEach(b=>b.addEventListener("click", ()=>setTab(b.dataset.tab)));
    $("logoHome").addEventListener("click", (e)=>{ e.preventDefault(); setTab("dashboard"); });

    // Modal framework
    function openModal(title, bodyHTML, actions=[], afterOpen){
      $("modalTitle").textContent = title;
      $("modalBody").innerHTML = bodyHTML;

      const act = $("modalActions");
      act.innerHTML = "";
      actions.forEach(a=>{
        const btn = document.createElement("button");
        btn.className = "btn " + (a.kind || "");
        btn.textContent = a.label;
        btn.addEventListener("click", a.onClick);
        act.appendChild(btn);
      });

      $("modalBack").style.display = "flex";
      if(afterOpen) setTimeout(afterOpen, 0);
    }
    function closeModal(){ $("modalBack").style.display = "none"; }
    $("modalClose").addEventListener("click", closeModal);
    $("modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });

    // Login (demo)
    function updateUserChip(){
      const c = $("userChip");
      if(c) c.textContent = state.user?.name ? state.user.name : "Guest";
    }
    $("btnLogin").addEventListener("click", ()=>{
      openModal("Login (demo)", `
        <div class="muted2">Local-only profile name (no backend yet).</div>
        <div style="height:10px"></div>
        <div class="row">
          <div class="field">
            <label>Profile name</label>
            <input id="loginName" placeholder="Gavin / Karly / Tester" value="${escapeHtml(state.user?.name||"Guest")}">
          </div>
        </div>
      `, [
        {label:"Cancel", kind:"secondary", onClick: closeModal},
        {label:"Save", kind:"", onClick: ()=>{
          state.user = { name: ($("loginName").value.trim() || "Guest") };
          save(); closeModal(); toast("Profile saved");
        }}
      ]);
    });

    // Theme button
    $("btnTheme").addEventListener("click", ()=>{
      setTheme(state.theme==="light" ? "dark" : "light");
    });

    // Quick tour
    $("btnQuickTour").addEventListener("click", ()=>{
      openModal("Quick Tour üß≠", `
        <div class="muted">
          <b>1)</b> Go to <b>Pay Setup</b> and set your monthly take-home.<br/><br/>
          <b>2)</b> Add your <b>Bills</b> with real due days.<br/><br/>
          <b>3)</b> Check <b>Payday Split</b> to see what hits each check.<br/><br/>
          <b>4)</b> Add <b>Debts</b> and set <b>Goals</b> buckets.<br/><br/>
          <b>5)</b> Use <b>Customize</b> to add more dashboard widgets.
        </div>
      `, [{label:"Got it", kind:"", onClick: closeModal}]);
    });

    // Dashboard shortcuts
    $("goProfileFromDash").addEventListener("click", ()=>setTab("profile"));
    $("goBillsFromDash").addEventListener("click", ()=>setTab("bills"));
    $("goPayFromDash").addEventListener("click", ()=>setTab("pay"));

    // Customize dashboard
    $("btnCustomizeDash").addEventListener("click", ()=>{
      const w = state.dashboardWidgets;
      openModal("Customize Dashboard", `
        <div class="muted">Toggle what you want to see on the dashboard.</div>
        <div style="height:12px"></div>

        <div class="row">
          <button class="btn secondary" id="togAlloc">${w.allocation ? "‚úÖ" : "‚ûï"} Allocation Progress</button>
          <button class="btn secondary" id="togQuick">${w.quickActions ? "‚úÖ" : "‚ûï"} Quick Actions</button>
          <button class="btn secondary" id="togVisual">${w.visual ? "‚úÖ" : "‚ûï"} Visual Breakdown</button>
          <button class="btn secondary" id="togNext">${w.nextUp ? "‚úÖ" : "‚ûï"} Next Up + Notes</button>
        </div>

        <div class="divider"></div>
        <div class="muted2">
          Clean default stays clean. Your dashboard is yours.
        </div>
      `, [
        {label:"Close", kind:"secondary", onClick: ()=>{ closeModal(); renderAll(); }}
      ], ()=>{
        const flip = (key)=>{
          state.dashboardWidgets[key] = !state.dashboardWidgets[key];
          save();
          closeModal();
          toast("Updated");
          renderAll();
        };
        $("togAlloc").onclick = ()=>flip("allocation");
        $("togQuick").onclick = ()=>flip("quickActions");
        $("togVisual").onclick = ()=>flip("visual");
        $("togNext").onclick = ()=>flip("nextUp");
      });
    });

    // Calculations
    function billsTotal(){ return state.bills.reduce((a,b)=>a+Number(b.amount||0),0); }
    function debtMonthlyTotal(){ return state.debts.reduce((a,d)=>a+Number(d.payment||0),0); }
    function goalsTotal(){
      const g = state.goals;
      return Number(g.emergency||0)+Number(g.invest||0)+Number(g.fun||0)+Number(g.groceries||0);
    }
    function userIncome(){ return Number(state.profile.monthlyIncome||0); }
    function spouseIncome(){ return (state.profile.spouseEnabled==="yes") ? Number(state.profile.spouseIncome||0) : 0; }
    function householdIncome(){ return userIncome() + spouseIncome(); }
    function remaining(){ return householdIncome() - (billsTotal()+goalsTotal()+debtMonthlyTotal()); }

    function routeBillToPaycheck(dueDay){
      const day = Number(dueDay||0);
      if(day >= 1 && day <= 14) return 1;
      return 2;
    }

    function paydaySplit(){
      const inc = householdIncome();
      const p1inc = inc/2;
      const p2inc = inc/2;

      const b1 = state.bills.filter(b=> routeBillToPaycheck(b.dueDay)===1 );
      const b2 = state.bills.filter(b=> routeBillToPaycheck(b.dueDay)===2 );

      const p1Bills = b1.reduce((a,b)=>a+Number(b.amount||0),0);
      const p2Bills = b2.reduce((a,b)=>a+Number(b.amount||0),0);

      const gHalf = goalsTotal()/2;
      const dHalf = debtMonthlyTotal()/2;

      const p1Out = p1Bills + gHalf + dHalf;
      const p2Out = p2Bills + gHalf + dHalf;

      return {
        p1inc, p2inc,
        p1Bills, p2Bills,
        gHalf, dHalf,
        p1Out, p2Out,
        p1Left: p1inc - p1Out,
        p2Left: p2inc - p2Out
      };
    }

    // Debts payoff estimate
    function estimatePayoffMonths(balance, apr, payment){
      balance = Number(balance||0);
      apr = Number(apr||0);
      payment = Number(payment||0);
      if(balance <= 0) return 0;
      if(payment <= 0) return Infinity;
      const r = (apr/100)/12;
      let months = 0;
      let b = balance;
      while(b > 0 && months < 1000){
        const interest = b * r;
        if(payment <= interest && r > 0) return Infinity;
        b = b + interest - payment;
        months++;
      }
      return months >= 1000 ? Infinity : months;
    }

    function estimateTotalPayoff(){
      if(state.debts.length === 0) return "‚Äî";
      const extra = Number(state.debtPlan.extra||0);
      const strat = state.debtPlan.strategy || "avalanche";

      let debts = state.debts.map(d=>({
        name:d.name,
        bal:Number(d.balance||0),
        apr:Number(d.apr||0),
        pay:Number(d.payment||0)
      })).filter(d=>d.bal>0);

      if(debts.length===0) return "0 months";

      let months = 0;
      while(debts.some(d=>d.bal>0) && months < 1200){
        debts = debts.filter(d=>d.bal>0);
        debts.sort((a,b)=>{
          if(strat==="snowball") return a.bal - b.bal;
          return b.apr - a.apr || b.bal - a.bal;
        });
        const target = debts[0];

        for(const d of debts){
          const r = (d.apr/100)/12;
          const interest = d.bal * r;
          d.bal += interest;
          let pay = d.pay;
          if(d===target) pay += extra;
          d.bal -= pay;
        }
        months++;
      }
      if(months>=1200) return "1200+ months";
      return months + " months";
    }

    // Status chip
    function renderStatusChip(){
      const rem = remaining();
      const dot = $("chipDot");
      const text = $("chipStatus");
      if(householdIncome() <= 0){
        dot.className = "dot warn";
        text.textContent = "Set income";
        return;
      }
      if(rem >= 200){
        dot.className = "dot good";
        text.textContent = "Healthy";
      } else if(rem >= 0){
        dot.className = "dot warn";
        text.textContent = "Tight";
      } else {
        dot.className = "dot bad";
        text.textContent = "Over budget";
      }
    }

    // Dashboard widgets render (minimal by default)
    function renderDashboard(){
      const inc = householdIncome();
      const b = billsTotal();
      const g = goalsTotal();
      const d = debtMonthlyTotal();
      const rem = remaining();

      $("mIncome").textContent = fmt(inc);
      $("mBills").textContent = fmt(b);
      $("mRemaining").textContent = fmt(rem);

      $("mRemaining").classList.toggle("good", rem >= 0);
      $("mRemaining").classList.toggle("bad", rem < 0);

      $("incomeHint").textContent =
        inc>0
          ? `Household = you ${fmt(userIncome())}${spouseIncome()>0 ? ` + spouse ${fmt(spouseIncome())}` : ""}`
          : "Set income in Pay Setup.";

      $("billHint").textContent = state.bills.length ? "Bills loaded." : "Add bills to tighten accuracy.";

      // Build widgets based on toggles
      const w = state.dashboardWidgets;
      const wrap = $("dashWidgets");
      wrap.innerHTML = "";

      if(w.allocation){
        const alloc = b+g+d;
        const pct = inc>0 ? clamp((alloc/inc)*100, 0, 140) : 0;

        wrap.appendChild(htmlToNode(`
          <div class="card" style="grid-column: span 7;">
            <h3>Allocation Progress <span class="muted2">${inc>0 ? pct.toFixed(0)+"% used" : ""}</span></h3>
            <div class="progress"><div class="bar" style="width:${clamp(pct,0,100).toFixed(0)}%"></div></div>
            <div style="height:10px"></div>
            <div class="kpiRow">
              <div class="kpi"><div class="t">Bills</div><div class="v">${fmt(b)}</div></div>
              <div class="kpi"><div class="t">Goals</div><div class="v">${fmt(g)}</div></div>
              <div class="kpi"><div class="t">Debt Payments</div><div class="v">${fmt(d)}</div></div>
            </div>
          </div>
        `));
      }

      if(w.quickActions){
        wrap.appendChild(htmlToNode(`
          <div class="card" style="grid-column: span 5;">
            <h3>Quick Actions</h3>
            <div class="row">
              <button class="btn" id="qaProfile">ü™ñ Setup Pay</button>
              <button class="btn secondary" id="qaBills">üßæ Bills</button>
              <button class="btn secondary" id="qaPay">üóìÔ∏è Payday Split</button>
              <button class="btn secondary" id="qaDebts">üí≥ Debts</button>
            </div>
            <div class="muted" style="margin-top:10px">Keep it simple. Add only what you use.</div>
          </div>
        `));

        setTimeout(()=>{
          $("qaProfile")?.addEventListener("click", ()=>setTab("profile"));
          $("qaBills")?.addEventListener("click", ()=>setTab("bills"));
          $("qaPay")?.addEventListener("click", ()=>setTab("pay"));
          $("qaDebts")?.addEventListener("click", ()=>setTab("debts"));
        }, 0);
      }

      if(w.visual){
        wrap.appendChild(htmlToNode(`
          <div class="card" style="grid-column: span 6;">
            <h3>Visual Breakdown <span class="muted2">Bills / Goals / Debt</span></h3>
            <canvas id="pie"></canvas>
            <div id="pieLegend" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px"></div>
          </div>
        `));
        setTimeout(()=>renderPie(), 0);
      }

      if(w.nextUp){
        const next = nextBillsHTML();
        wrap.appendChild(htmlToNode(`
          <div class="card" style="grid-column: span 6;">
            <h3>Next Up <span class="muted2">sorted by due day</span></h3>
            <div id="nextUp">${next}</div>
            <div class="divider"></div>
            <h3>Notes</h3>
            <textarea id="notes" placeholder="Example: 'Pay car early if paycheck hits late.'"></textarea>
            <div class="muted2" style="margin-top:8px">Autosaves.</div>
          </div>
        `));
        setTimeout(()=>{
          const n = $("notes");
          if(n){
            n.value = state.notes || "";
            n.addEventListener("input", ()=>{
              state.notes = n.value;
              save();
            });
          }
        }, 0);
      }

      renderStatusChip();
      updateUserChip();
    }

    function nextBillsHTML(){
      if(state.bills.length===0) return `<div class="muted">Add bills to see what hits first.</div>`;
      const sorted = [...state.bills].sort((a,b)=> (Number(a.dueDay||99)-Number(b.dueDay||99)) || (Number(b.amount||0)-Number(a.amount||0)));
      const top = sorted.slice(0,6).map(b=>(
        `<div style="display:flex;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.10)">
          <div><b>${escapeHtml(b.name)}</b> <span style="opacity:.8">(Due ${Number(b.dueDay||0)})</span></div>
          <div>${fmt(b.amount)}</div>
        </div>`
      )).join("");
      return top + (sorted.length>6 ? `<div class="muted2" style="padding-top:10px">+${sorted.length-6} more</div>` : "");
    }

    // Pay render
    function renderPay(){
      const inc = householdIncome();
      if(inc <= 0){
        $("p1Income").textContent = fmt(0);
        $("p2Income").textContent = fmt(0);
        $("pRemainCombined").textContent = fmt(0);
        $("p1Rows").innerHTML = `<tr><td colspan="3" class="muted">Set income in Pay Setup.</td></tr>`;
        $("p2Rows").innerHTML = `<tr><td colspan="3" class="muted">Set income in Pay Setup.</td></tr>`;
        return;
      }

      const s = paydaySplit();
      $("p1Income").textContent = fmt(s.p1inc);
      $("p2Income").textContent = fmt(s.p2inc);
      $("pRemainCombined").textContent = fmt(s.p1Left + s.p2Left);

      $("p1Out").textContent = fmt(s.p1Out);
      $("p2Out").textContent = fmt(s.p2Out);
      $("p1Left").textContent = fmt(s.p1Left);
      $("p2Left").textContent = fmt(s.p2Left);

      $("p1Left").style.color = s.p1Left>=0 ? "var(--good)" : "var(--bad)";
      $("p2Left").style.color = s.p2Left>=0 ? "var(--good)" : "var(--bad)";
      $("pRemainCombined").style.color = (s.p1Left+s.p2Left)>=0 ? "var(--good)" : "var(--bad)";

      const b1 = state.bills.filter(b=> routeBillToPaycheck(b.dueDay)===1 );
      const b2 = state.bills.filter(b=> routeBillToPaycheck(b.dueDay)===2 );

      const gHalf = goalsTotal()/2;
      const dHalf = debtMonthlyTotal()/2;

      const p1Items = [
        ...b1.map(b=>({name:`${b.name} (Due ${b.dueDay})`, type:"Bill", amount:Number(b.amount||0)})),
        ...(gHalf>0 ? [{name:"Goals (half)", type:"Goals", amount:gHalf}] : []),
        ...(dHalf>0 ? [{name:"Debt payments (half)", type:"Debt", amount:dHalf}] : [])
      ];
      const p2Items = [
        ...b2.map(b=>({name:`${b.name} (Due ${b.dueDay})`, type:"Bill", amount:Number(b.amount||0)})),
        ...(gHalf>0 ? [{name:"Goals (half)", type:"Goals", amount:gHalf}] : []),
        ...(dHalf>0 ? [{name:"Debt payments (half)", type:"Debt", amount:dHalf}] : [])
      ];

      $("p1Rows").innerHTML = p1Items.length
        ? p1Items.map(i=>row3(i.name, i.type, i.amount)).join("")
        : `<tr><td colspan="3" class="muted">No items routed to Paycheck #1 yet.</td></tr>`;

      $("p2Rows").innerHTML = p2Items.length
        ? p2Items.map(i=>row3(i.name, i.type, i.amount)).join("")
        : `<tr><td colspan="3" class="muted">No items routed to Paycheck #2 yet.</td></tr>`;
    }

    function row3(a,b,c){
      return `<tr><td><b>${escapeHtml(a)}</b></td><td>${escapeHtml(b)}</td><td>${fmt(c)}</td></tr>`;
    }

    // Bills render
    function renderBills(){
      const search = ($("billSearch").value || "").trim().toLowerCase();
      const sort = $("billSort").value || "due";

      let list = [...state.bills];

      if(search){
        list = list.filter(b =>
          (b.name||"").toLowerCase().includes(search) ||
          (b.category||"").toLowerCase().includes(search)
        );
      }

      list.sort((a,b)=>{
        if(sort==="due") return (Number(a.dueDay||99)-Number(b.dueDay||99)) || (Number(b.amount||0)-Number(a.amount||0));
        if(sort==="amountDesc") return (Number(b.amount||0)-Number(a.amount||0));
        if(sort==="amountAsc") return (Number(a.amount||0)-Number(b.amount||0));
        if(sort==="name") return (a.name||"").localeCompare(b.name||"");
        if(sort==="cat") return (a.category||"").localeCompare(b.category||"");
        return 0;
      });

      const rows = $("billRows");
      if(list.length===0){
        rows.innerHTML = `<tr><td colspan="6" class="muted">No bills yet. Add one above.</td></tr>`;
      } else {
        rows.innerHTML = list.map((b)=>{
          const route = routeBillToPaycheck(b.dueDay)===1 ? "Paycheck #1" : "Paycheck #2";
          return `
            <tr>
              <td><b>${escapeHtml(b.name)}</b></td>
              <td>${escapeHtml(b.category||"Other")}</td>
              <td>Day ${Number(b.dueDay||0)}</td>
              <td>${route}</td>
              <td>${fmt(b.amount)}</td>
              <td style="text-align:right">
                <button class="btn small secondary" onclick="editBill('${b.id}')">Edit</button>
                <button class="btn small danger" onclick="delBill('${b.id}')">Delete</button>
              </td>
            </tr>
          `;
        }).join("");
      }
    }

    // Debts render
    function renderDebts(){
      const total = state.debts.reduce((a,d)=>a+Number(d.balance||0),0);
      const monthly = debtMonthlyTotal();
      $("debtTotal").textContent = fmt(total);
      $("debtMonthly").textContent = fmt(monthly);
      $("debtPayoff").textContent = estimateTotalPayoff();

      $("extraDebt").value = state.debtPlan.extra ?? 0;
      $("debtStrategy").value = state.debtPlan.strategy || "avalanche";

      const rows = $("debtRows");
      if(state.debts.length===0){
        rows.innerHTML = `<tr><td colspan="6" class="muted">No debts yet. Add one above.</td></tr>`;
      } else {
        rows.innerHTML = state.debts.map(d=>{
          const months = estimatePayoffMonths(d.balance, d.apr, d.payment);
          const mText = (months===Infinity) ? "‚àû" : String(months);
          return `
            <tr>
              <td><b>${escapeHtml(d.name)}</b></td>
              <td>${fmt(d.balance)}</td>
              <td>${Number(d.apr||0).toFixed(2)}%</td>
              <td>${fmt(d.payment)}</td>
              <td>${mText}</td>
              <td style="text-align:right">
                <button class="btn small secondary" onclick="editDebt('${d.id}')">Edit</button>
                <button class="btn small danger" onclick="delDebt('${d.id}')">Delete</button>
              </td>
            </tr>
          `;
        }).join("");
      }
    }

    // Goals render
    function renderGoals(){
      const g = state.goals;
      $("gEmergency").value = g.emergency ?? 0;
      $("gInvest").value = g.invest ?? 0;
      $("gFun").value = g.fun ?? 0;
      $("gGroc").value = g.groceries ?? 0;

      const gt = goalsTotal();
      $("goalsTotal").textContent = fmt(gt);

      const inc = householdIncome();
      const suggested = inc>0 ? (gt/inc)*100 : 0;
      $("saveRate").textContent = inc>0 ? suggested.toFixed(0) + "% of income" : "‚Äî";

      const left = householdIncome() - (billsTotal()+debtMonthlyTotal()+gt);
      $("leftAfterGoals").textContent = fmt(left);
      $("leftAfterGoals").style.color = left>=0 ? "var(--good)" : "var(--bad)";
    }

    // Profile render + helper
    function renderProfile(){
      const p = state.profile;
      $("paySchedule").value = p.paySchedule || "1st15th";
      $("incomeMonthly").value = p.monthlyIncome ?? 0;
      $("spouseEnabled").value = p.spouseEnabled || "no";
      $("spouseIncome").value = p.spouseIncome ?? 0;

      $("rank").value = p.rank || "";
      $("yos").value = p.yos ?? 0;
      $("basEnabled").value = p.basEnabled || "yes";
      $("bah").value = p.bah ?? 0;
      $("basePay").value = p.basePay ?? 0;
      $("bas").value = p.bas ?? 0;

      updateCalcBoxes();
      updateUserChip();
    }

    function updateCalcBoxes(){
      const base = Number($("basePay").value||0);
      const bah = Number($("bah").value||0);
      const bas = Number($("bas").value||0);
      const calc = base+bah+bas;
      $("calcTotal").value = calc>0 ? fmt(calc) : "";
    }

    function pickBasePay(rank, yos){
      if(!rank || !BASEPAY_2026[rank]) return 0;
      const years = Math.max(0, Math.min(40, Math.floor(Number(yos||0))));
      // Find the highest threshold <= years. The table columns are "Over X" so:
      // <=2 uses bucket 0, >2 uses bucket 1, >3 uses bucket 2, etc.
      // We‚Äôll compute the right bucket index by counting thresholds passed.
      let idx = 0;
      for(let i=1;i<YOS_THRESH.length;i++){
        const thr = YOS_THRESH[i];
        // "Over thr" means years > thr
        if(years > thr) idx = i;
      }
      // Safety clamp
      idx = Math.min(idx, BASEPAY_2026[rank].length-1);
      // Some ranks (E9) we only filled from 20+; below that returns 0 (intentional planning guard).
      return Number(BASEPAY_2026[rank][idx] || 0);
    }

    // Pie chart (only if widget enabled)
    function renderPie(){
      const canvas = document.getElementById("pie");
      const legend = document.getElementById("pieLegend");
      if(!canvas || !legend) return;

      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(180 * dpr);
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(dpr, dpr);

      const inc = householdIncome();
      const b = billsTotal();
      const g = goalsTotal();
      const d = debtMonthlyTotal();
      const rem = Math.max(0, remaining());

      const parts = [
        {name:"Bills", val:b, color:"rgba(110,168,255,.95)"},
        {name:"Goals", val:g, color:"rgba(70,255,175,.92)"},
        {name:"Debt", val:d, color:"rgba(255,208,112,.95)"},
        {name:"Remaining", val:rem, color:"rgba(255,255,255,.20)"}
      ];
      const total = parts.reduce((a,p)=>a+p.val,0);

      ctx.clearRect(0,0,rect.width,180);
      const cx = rect.width/2;
      const cy = 90;
      const r = 62;

      if(total <= 0){
        ctx.beginPath();
        ctx.arc(cx,cy,r,0,Math.PI*2);
        ctx.fillStyle = "rgba(255,255,255,.08)";
        ctx.fill();
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
        ctx.font = "900 12px ui-sans-serif, system-ui";
        ctx.textAlign = "center";
        ctx.fillText("Add income to see chart", cx, cy+4);
        legend.innerHTML = `<span class="muted2">No data</span>`;
        return;
      }

      let start = -Math.PI/2;
      parts.forEach((p)=>{
        const angle = (p.val/total)*Math.PI*2;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,start,start+angle);
        ctx.closePath();
        ctx.fillStyle = p.color;
        ctx.fill();
        start += angle;
      });

      ctx.beginPath();
      ctx.arc(cx,cy,38,0,Math.PI*2);
      ctx.fillStyle = (document.documentElement.getAttribute("data-theme")==="light")
        ? "rgba(255,255,255,.88)"
        : "rgba(0,0,0,.22)";
      ctx.fill();

      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text');
      ctx.font = "950 14px ui-sans-serif, system-ui";
      ctx.textAlign = "center";
      ctx.fillText("Income", cx, cy-4);
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
      ctx.font = "950 12px ui-sans-serif, system-ui";
      ctx.fillText(fmt(inc), cx, cy+16);

      legend.innerHTML = parts.map(p=>{
        const pct = (p.val/total)*100;
        return `<span class="tagBtn" style="cursor:default">
          <span style="width:10px;height:10px;border-radius:99px;background:${p.color};display:inline-block"></span>
          ${p.name}: ${pct.toFixed(0)}%
        </span>`;
      }).join(" ");
    }

    function htmlToNode(html){
      const t = document.createElement("template");
      t.innerHTML = html.trim();
      return t.content.firstChild;
    }

    // Bills CRUD
    window.delBill = (id)=>{
      openModal("Delete bill?", `<div class="muted">This bill will be removed.</div>`, [
        {label:"Cancel", kind:"secondary", onClick: closeModal},
        {label:"Delete", kind:"danger", onClick: ()=>{
          state.bills = state.bills.filter(b=>b.id!==id);
          save(); closeModal(); renderAll(); toast("Bill deleted");
        }}
      ]);
    };

    window.editBill = (id)=>{
      const b = state.bills.find(x=>x.id===id);
      if(!b) return;
      openModal("Edit Bill", `
        <div class="row">
          <div class="field"><label>Name</label><input id="mb_name" value="${escapeHtml(b.name)}"></div>
          <div class="field"><label>Amount</label><input id="mb_amt" type="number" step="0.01" value="${Number(b.amount||0)}"></div>
          <div class="field"><label>Due day (1‚Äì31)</label><input id="mb_due" type="number" min="1" max="31" step="1" value="${Number(b.dueDay||1)}"></div>
          <div class="field"><label>Category</label>
            <select id="mb_cat">
              <option>Housing</option><option>Transportation</option><option>Insurance</option>
              <option>Utilities</option><option>Subscriptions</option><option>Phone/Internet</option>
              <option>Other</option>
            </select>
          </div>
        </div>
      `, [
        {label:"Cancel", kind:"secondary", onClick: closeModal},
        {label:"Save", kind:"", onClick: ()=>{
          b.name = $("mb_name").value.trim() || b.name;
          b.amount = Number($("mb_amt").value||0);
          b.dueDay = clamp(Number($("mb_due").value||1), 1, 31);
          b.category = $("mb_cat").value;
          save(); closeModal(); renderAll(); toast("Bill updated");
        }}
      ], ()=>{
        $("mb_cat").value = b.category || "Other";
      });
    };

    // Debts CRUD
    window.delDebt = (id)=>{
      openModal("Delete debt?", `<div class="muted">This debt will be removed.</div>`, [
        {label:"Cancel", kind:"secondary", onClick: closeModal},
        {label:"Delete", kind:"danger", onClick: ()=>{
          state.debts = state.debts.filter(d=>d.id!==id);
          save(); closeModal(); renderAll(); toast("Debt deleted");
        }}
      ]);
    };

    window.editDebt = (id)=>{
      const d = state.debts.find(x=>x.id===id);
      if(!d) return;
      openModal("Edit Debt", `
        <div class="row">
          <div class="field"><label>Name</label><input id="md_name" value="${escapeHtml(d.name)}"></div>
          <div class="field"><label>Balance</label><input id="md_bal" type="number" step="0.01" value="${Number(d.balance||0)}"></div>
          <div class="field"><label>APR %</label><input id="md_apr" type="number" step="0.01" value="${Number(d.apr||0)}"></div>
          <div class="field"><label>Payment (monthly)</label><input id="md_pay" type="number" step="0.01" value="${Number(d.payment||0)}"></div>
        </div>
      `, [
        {label:"Cancel", kind:"secondary", onClick: closeModal},
        {label:"Save", kind:"", onClick: ()=>{
          d.name = $("md_name").value.trim() || d.name;
          d.balance = Number($("md_bal").value||0);
          d.apr = Number($("md_apr").value||0);
          d.payment = Number($("md_pay").value||0);
          save(); closeModal(); renderAll(); toast("Debt updated");
        }}
      ]);
    };

    // Bills events
    $("addBill").addEventListener("click", ()=>{
      const name = $("billName").value.trim();
      const amount = Number($("billAmount").value||0);
      const dueDay = clamp(Number($("billDueDay").value||0), 1, 31);
      const category = $("billCat").value;

      if(!name){ toast("Add a bill name"); return; }
      if(!(amount>0)){ toast("Enter a valid amount"); return; }
      if(!(dueDay>=1 && dueDay<=31)){ toast("Due day must be 1‚Äì31"); return; }

      state.bills.push({ id: uuid(), name, amount, dueDay, category });

      $("billName").value = "";
      $("billAmount").value = "";
      $("billDueDay").value = "";

      save(); renderAll(); toast("Bill added");
    });

    $("clearBillInputs").addEventListener("click", ()=>{
      $("billName").value=""; $("billAmount").value="";
      $("billDueDay").value=""; $("billCat").value="Housing";
    });

    $("billSearch").addEventListener("input", renderBills);
    $("billSort").addEventListener("change", renderBills);

    // Debts events
    $("addDebt").addEventListener("click", ()=>{
      const name = $("debtName").value.trim();
      const balance = Number($("debtBal").value||0);
      const apr = Number($("debtApr").value||0);
      const payment = Number($("debtPay").value||0);
      if(!name){ toast("Add a debt name"); return; }
      if(!(balance>0)){ toast("Enter a valid balance"); return; }

      state.debts.push({ id: uuid(), name, balance, apr, payment });
      $("debtName").value=""; $("debtBal").value=""; $("debtApr").value=""; $("debtPay").value="";
      save(); renderAll(); toast("Debt added");
    });

    $("clearDebtInputs").addEventListener("click", ()=>{
      $("debtName").value=""; $("debtBal").value=""; $("debtApr").value=""; $("debtPay").value="";
    });

    $("extraDebt").addEventListener("input", ()=>{
      state.debtPlan.extra = Number($("extraDebt").value||0);
      save(); renderAll();
    });
    $("debtStrategy").addEventListener("change", ()=>{
      state.debtPlan.strategy = $("debtStrategy").value;
      save(); renderAll();
    });

    // Goals events
    $("saveGoals").addEventListener("click", ()=>{
      state.goals.emergency = Number($("gEmergency").value||0);
      state.goals.invest = Number($("gInvest").value||0);
      state.goals.fun = Number($("gFun").value||0);
      state.goals.groceries = Number($("gGroc").value||0);
      save(); renderAll(); toast("Goals saved");
    });

    $("zeroGoals").addEventListener("click", ()=>{
      state.goals = { emergency:0, invest:0, fun:0, groceries:0 };
      save(); renderAll(); toast("Goals cleared");
    });

    // Profile events
    ["basePay","bah","bas","incomeMonthly","spouseIncome","spouseEnabled","rank","yos","basEnabled","paySchedule"]
      .forEach(id=> $(id).addEventListener("input", ()=>{ updateCalcBoxes(); }));

    $("btnUseCalcAsIncome").addEventListener("click", ()=>{
      const base = Number($("basePay").value||0);
      const bah = Number($("bah").value||0);
      const bas = Number($("bas").value||0);
      const calc = base+bah+bas;
      $("incomeMonthly").value = calc>0 ? calc : 0;
      toast("Used gross as take-home (edit if needed)");
      updateCalcBoxes();
    });

    $("applyRank").addEventListener("click", ()=>{
      const r = $("rank").value;
      const yos = Number($("yos").value||0);

      if(!r){ toast("Pick a rank first"); return; }

      const base = pickBasePay(r, yos);
      if(base <= 0){
        toast("No base pay found for that selection (E-9 below 20+ not enabled yet).");
        return;
      }

      $("basePay").value = base.toFixed(2);

      const basOn = ($("basEnabled").value === "yes");
      $("bas").value = basOn ? BAS_2026_ENLISTED.toFixed(2) : "0.00";

      updateCalcBoxes();
      toast("Auto-filled (2026). You can still edit manually.");
    });

    $("btnExplainPay").addEventListener("click", ()=>{
      openModal("Military Pay Helper", `
        <div class="muted">
          <b>Base Pay:</b> pulled from the official 2026 DFAS enlisted pay table by rank + years of service.<br/><br/>
          <b>BAS:</b> uses the official 2026 enlisted BAS rate, but you can toggle BAS off (field ops / meal card / etc).<br/><br/>
          <b>BAH:</b> varies by ZIP + grade + dependents. We keep this manual for now (accurate when you enter your real amount).
        </div>
      `, [{label:"Got it", kind:"", onClick: closeModal}]);
    });

    $("saveProfile").addEventListener("click", ()=>{
      const p = state.profile;
      p.paySchedule = $("paySchedule").value;
      p.monthlyIncome = Number($("incomeMonthly").value||0);
      p.spouseEnabled = $("spouseEnabled").value;
      p.spouseIncome = Number($("spouseIncome").value||0);

      p.rank = $("rank").value || "";
      p.yos = Math.max(0, Math.min(40, Math.floor(Number($("yos").value||0))));
      p.basEnabled = $("basEnabled").value;
      p.basePay = Number($("basePay").value||0);
      p.bas = Number($("bas").value||0);
      p.bah = Number($("bah").value||0);

      save(); renderAll(); toast("Pay setup saved");
    });

    // Settings
    $("feedbackNotes").addEventListener("input", ()=>{
      state.feedbackNotes = $("feedbackNotes").value;
      save();
    });

    $("btnExport").addEventListener("click", ()=>{
      const data = JSON.stringify(state, null, 2);
      openModal("Export Data", `
        <div class="muted">Copy this JSON to backup. You can import it later.</div>
        <div style="height:10px"></div>
        <textarea style="min-height:220px">${escapeHtml(data)}</textarea>
      `, [
        {label:"Close", kind:"secondary", onClick: closeModal},
        {label:"Copy", kind:"", onClick: ()=>{
          navigator.clipboard?.writeText(data);
          toast("Copied");
        }}
      ]);
    });

    $("btnImport").addEventListener("click", ()=>{
      openModal("Import Data", `
        <div class="muted">Paste JSON here to restore a budget.</div>
        <div style="height:10px"></div>
        <textarea id="importBox" style="min-height:220px" placeholder="Paste exported JSON..."></textarea>
      `, [
        {label:"Cancel", kind:"secondary", onClick: closeModal},
        {label:"Import", kind:"", onClick: ()=>{
          try{
            const raw = $("importBox").value.trim();
            const obj = JSON.parse(raw);
            localStorage.setItem(KEY, JSON.stringify(obj));
            toast("Imported");
            closeModal();
            location.reload();
          } catch(e){
            toast("Invalid JSON");
          }
        }}
      ]);
    });

    $("btnDemo").addEventListener("click", ()=>{
      openModal("Load Demo Data?", `
        <div class="muted">Loads realistic testing data (bills + debts + goals).</div>
      `, [
        {label:"Cancel", kind:"secondary", onClick: closeModal},
        {label:"Load Demo", kind:"", onClick: ()=>{
          loadDemo();
          closeModal();
          toast("Demo loaded");
        }}
      ]);
    });

    $("btnWipe").addEventListener("click", ()=>{
      openModal("Wipe Everything?", `
        <div class="muted"><b>This clears all stored data.</b></div>
        <div style="height:10px"></div>
        <div class="muted2">Type <b>WIPE</b> to confirm:</div>
        <div style="height:8px"></div>
        <input id="wipeWord" placeholder="WIPE" />
      `, [
        {label:"Cancel", kind:"secondary", onClick: closeModal},
        {label:"Wipe", kind:"danger", onClick: ()=>{
          const word = ($("wipeWord")?.value||"").trim().toUpperCase();
          if(word !== "WIPE"){ toast("Type WIPE to confirm"); return; }
          localStorage.removeItem(KEY);
          closeModal();
          toast("Wiped");
          setTimeout(()=>location.reload(), 350);
        }}
      ]);
    });

    $("btnPrint").addEventListener("click", ()=>{
      const inc = householdIncome();
      const b = billsTotal();
      const g = goalsTotal();
      const d = debtMonthlyTotal();
      const rem = remaining();
      const s = paydaySplit();

      const billLines = state.bills
        .sort((a,b)=>Number(a.dueDay||99)-Number(b.dueDay||99))
        .map(x=>`‚Ä¢ ${x.name} (Due day ${x.dueDay}) - ${fmt(x.amount)}`)
        .join("\\n");

      const debtLines = state.debts
        .map(x=>`‚Ä¢ ${x.name} - Balance ${fmt(x.balance)}, Payment ${fmt(x.payment)}, APR ${Number(x.apr||0).toFixed(2)}%`)
        .join("\\n");

      const text =
`MilBudget Summary
=================
Household income: ${fmt(inc)}
Bills total:      ${fmt(b)}
Goals total:      ${fmt(g)}
Debt payments:    ${fmt(d)}
Remaining:        ${fmt(rem)}

Payday Split
-----------
Paycheck #1 income: ${fmt(s.p1inc)} | Out: ${fmt(s.p1Out)} | Left: ${fmt(s.p1Left)}
Paycheck #2 income: ${fmt(s.p2inc)} | Out: ${fmt(s.p2Out)} | Left: ${fmt(s.p2Left)}

Bills
-----
${billLines || "(none)"}

Debts
-----
${debtLines || "(none)"}

Notes
-----
${state.notes || "(none)"}
`;
      openModal("Print Summary", `
        <div class="muted">Copy this to Notes or email it.</div>
        <div style="height:10px"></div>
        <textarea style="min-height:260px">${escapeHtml(text)}</textarea>
      `, [{label:"Close", kind:"secondary", onClick: closeModal}]);
    });

    // Demo data
    function loadDemo(){
      state.user = { name:"MilBudget Demo" };
      state.dashboardWidgets = { allocation:true, quickActions:true, visual:true, nextUp:true };

      state.profile.paySchedule = "1st15th";
      state.profile.monthlyIncome = 4200;
      state.profile.spouseEnabled = "yes";
      state.profile.spouseIncome = 1200;

      state.profile.rank = "E3";
      state.profile.yos = 2;
      state.profile.basEnabled = "yes";
      state.profile.basePay = pickBasePay("E3", 2);
      state.profile.bas = BAS_2026_ENLISTED;
      state.profile.bah = 1600;

      state.bills = [
        {id:uuid(), name:"Rent", amount:975, dueDay:1, category:"Housing"},
        {id:uuid(), name:"Car Payment", amount:502, dueDay:15, category:"Transportation"},
        {id:uuid(), name:"Car Insurance", amount:250, dueDay:5, category:"Insurance"},
        {id:uuid(), name:"Phone", amount:85, dueDay:20, category:"Phone/Internet"},
        {id:uuid(), name:"Internet", amount:60, dueDay:18, category:"Utilities"},
        {id:uuid(), name:"Gym", amount:35, dueDay:12, category:"Subscriptions"},
      ];

      state.debts = [
        {id:uuid(), name:"Camry Loan", balance:8000, apr:6.00, payment:502},
        {id:uuid(), name:"Credit Card", balance:1200, apr:24.99, payment:75},
      ];
      state.debtPlan.extra = 50;
      state.debtPlan.strategy = "avalanche";

      state.goals = { emergency:200, invest:100, fun:150, groceries:350 };
      state.notes = "Demo notes: customize dashboard, then edit bills to see split update.";
      state.feedbackNotes = "";

      save();
      renderAll();
    }

    // Hook up navigation buttons
    $("btnGoBills")?.addEventListener("click", ()=>setTab("bills"));
    $("btnGoProfile2")?.addEventListener("click", ()=>setTab("profile"));

    // Bills search/sort init
    $("billSort").value = "due";

    // Render all
    function renderAll(){
      renderDashboard();
      renderPay();
      renderBills();
      renderDebts();
      renderGoals();
      renderProfile();
      renderStatusChip();
      if(state.dashboardWidgets.visual) renderPie();
    }

    // Init
    document.documentElement.setAttribute("data-theme", state.theme==="light" ? "light" : "dark");
    $("feedbackNotes").value = state.feedbackNotes || "";

    window.addEventListener("resize", ()=>{ if(state.dashboardWidgets.visual) renderPie(); });

    renderAll();
  </script>
</body>
</html>
