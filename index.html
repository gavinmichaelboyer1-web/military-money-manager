<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MilBudget</title>
  <meta name="description" content="MilBudget - simple money control for Soldiers & families." />
  <style>
    :root{
      --bg:#0b1220;
      --bg2:#070c16;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.09);
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.93);
      --muted:rgba(255,255,255,.67);
      --muted2:rgba(255,255,255,.5);
      --good:rgba(70,255,175,.92);
      --bad:rgba(255,95,95,.96);
      --warn:rgba(255,208,112,.95);
      --brand:rgba(110,168,255,.98);
      --shadow: 0 18px 42px rgba(0,0,0,.5);
      --radius:18px;
      --radius2:22px;
      --btn: rgba(110,168,255,.16);
      --btnstroke: rgba(110,168,255,.45);
      --chip: rgba(255,255,255,.07);
      --chipstroke: rgba(255,255,255,.14);
      --gridgap: 14px;
    }

    /* Light theme */
    [data-theme="light"]{
      --bg:#f5f7ff;
      --bg2:#eef2ff;
      --panel:rgba(0,0,0,.05);
      --panel2:rgba(0,0,0,.07);
      --stroke:rgba(0,0,0,.12);
      --text:rgba(0,0,0,.88);
      --muted:rgba(0,0,0,.62);
      --muted2:rgba(0,0,0,.46);
      --shadow: 0 18px 42px rgba(0,0,0,.18);
      --btn: rgba(110,168,255,.22);
      --btnstroke: rgba(110,168,255,.50);
      --chip: rgba(0,0,0,.04);
      --chipstroke: rgba(0,0,0,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1000px 520px at 18% -10%, rgba(110,168,255,.26), transparent 70%),
        radial-gradient(900px 520px at 92% 10%, rgba(70,255,175,.18), transparent 70%),
        radial-gradient(760px 520px at 50% 120%, rgba(255,95,95,.16), transparent 70%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      min-height:100vh;
    }
    a{color:inherit}
    .app{
      display:grid;
      grid-template-columns: 300px 1fr;
      min-height:100vh;
    }

    /* Sidebar */
    .sidebar{
      padding:18px;
      border-right:1px solid var(--stroke);
      background:rgba(0,0,0,.08);
      backdrop-filter: blur(10px);
    }
    [data-theme="light"] .sidebar{ background:rgba(255,255,255,.55); }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:12px 12px;
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      background:var(--panel);
      box-shadow: var(--shadow);
    }
    .logo{
      width:40px; height:40px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(110,168,255,.98), rgba(70,255,175,.88));
      display:grid; place-items:center;
      font-weight:900;
      color: rgba(0,0,0,.78);
      letter-spacing:-.02em;
    }
    .brand h1{font-size:16px; margin:0; line-height:1.1}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}
    .chips{
      margin-top:12px;
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--chipstroke);
      background: var(--chip);
      font-size:12px;
      color: var(--muted);
    }
    .dot{
      width:10px; height:10px; border-radius:99px;
      background: rgba(255,255,255,.25);
      border: 1px solid rgba(255,255,255,.18);
    }
    .dot.good{background: var(--good); border-color: rgba(0,0,0,.1)}
    .dot.warn{background: var(--warn); border-color: rgba(0,0,0,.1)}
    .dot.bad{background: var(--bad); border-color: rgba(0,0,0,.1)}

    .nav{
      margin-top:14px;
      display:flex; flex-direction:column; gap:10px;
    }
    .nav button{
      width:100%;
      text-align:left;
      border:1px solid var(--stroke);
      background:var(--panel);
      color:var(--text);
      padding:12px 12px;
      border-radius:16px;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s border;
      display:flex; align-items:center; justify-content:space-between;
      font-weight:750;
      letter-spacing:-.01em;
    }
    .nav button:hover{ transform: translateY(-1px); background:var(--panel2) }
    .nav button.active{ border-color: rgba(110,168,255,.62); background: rgba(110,168,255,.12) }
    .nav small{font-weight:650; color: var(--muted);}

    .hint{
      margin-top:14px;
      padding:12px;
      border:1px dashed rgba(255,255,255,.22);
      border-radius:16px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
      background: rgba(0,0,0,.08);
    }
    [data-theme="light"] .hint{ background: rgba(255,255,255,.55); border-color: rgba(0,0,0,.14); }

    .sidebarFooter{
      margin-top:14px;
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }

    /* Main */
    .main{
      padding:22px;
      max-width: 1180px;
      width:100%;
      margin:0 auto;
    }
    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom: 16px;
    }
    .titleBlock h2{ margin:0; font-size:22px; letter-spacing:-.02em }
    .titleBlock .sub{ margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35}
    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:flex; gap:8px; align-items:center;
      border:1px solid var(--stroke);
      background:var(--panel);
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      box-shadow: var(--shadow);
    }
    .pill span{ color:var(--muted) }
    .pill strong{ font-weight:850; letter-spacing:-.01em }

    .btn{
      border:1px solid var(--btnstroke);
      background: var(--btn);
      color: var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.15s transform, .15s background;
      font-weight:800;
      font-size:13px;
      letter-spacing:-.01em;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(110,168,255,.24) }
    .btn.secondary{
      border:1px solid var(--stroke);
      background: var(--panel);
      font-weight:750;
    }
    .btn.danger{
      border-color: rgba(255,95,95,.55);
      background: rgba(255,95,95,.12);
    }
    .btn.ghost{
      border:1px solid var(--stroke);
      background: transparent;
    }
    .btn.small{ padding:8px 10px; border-radius:12px; font-size:12px; font-weight:800; }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--gridgap);
    }
    .card{
      border:1px solid var(--stroke);
      background:var(--panel);
      border-radius:var(--radius2);
      padding:14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .card h3{
      margin:0 0 10px;
      font-size:13px;
      color:var(--muted);
      font-weight:750;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--chipstroke);
      background: var(--chip);
      font-size:12px;
      color: var(--muted);
      font-weight:750;
      white-space:nowrap;
    }
    .metric{
      font-size:28px;
      font-weight:900;
      letter-spacing:-.03em;
    }
    .metric.good{ color: var(--good) }
    .metric.bad{ color: var(--bad) }
    .metric.warn{ color: var(--warn) }

    .row{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:flex-end;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:7px;
      flex:1;
      min-width: 180px;
    }
    label{ font-size:12px; color:var(--muted); font-weight:750 }
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    [data-theme="light"] input,
    [data-theme="light"] select,
    [data-theme="light"] textarea{
      background: rgba(255,255,255,.72);
    }
    textarea{ min-height: 88px; resize: vertical; }
    input::placeholder{ color:rgba(255,255,255,.35) }
    [data-theme="light"] input::placeholder{ color:rgba(0,0,0,.35) }

    .muted{ color:var(--muted); font-size:13px; line-height:1.35 }
    .muted2{ color:var(--muted2); font-size:12px; line-height:1.35 }

    .progress{
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    [data-theme="light"] .progress{
      background: rgba(0,0,0,.06);
      border-color: rgba(0,0,0,.10);
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(110,168,255,.98), rgba(70,255,175,.92));
    }

    .section{ display:none }
    .section.active{ display:block }

    .split2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gridgap);
    }

    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.14);
    }
    [data-theme="light"] .table{ background: rgba(255,255,255,.70); }
    .table th, .table td{
      padding:11px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-align:left;
      font-size:13px;
      vertical-align:middle;
    }
    [data-theme="light"] .table th, [data-theme="light"] .table td{ border-bottom-color: rgba(0,0,0,.08); }
    .table th{
      color:var(--muted);
      font-weight:850;
      font-size:12px;
      letter-spacing:.01em;
    }
    .table tr:last-child td{ border-bottom:none; }

    .pillRow{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }

    .kpiRow{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .kpi{
      flex:1; min-width: 170px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    [data-theme="light"] .kpi{ background: rgba(0,0,0,.04); border-color: rgba(0,0,0,.10); }
    .kpi .t{ color:var(--muted); font-size:12px; font-weight:800; }
    .kpi .v{ font-weight:950; font-size:18px; margin-top:4px; letter-spacing:-.02em }

    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.55);
      color:var(--text);
      box-shadow: var(--shadow);
      opacity:0;
      transform: translateY(10px);
      transition: .2s;
      max-width: 360px;
      pointer-events:none;
      font-size:13px;
    }
    [data-theme="light"] .toast{ background: rgba(255,255,255,.88); }
    .toast.show{ opacity:1; transform: translateY(0) }

    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(720px, 100%);
      border-radius:22px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding:14px;
    }
    [data-theme="light"] .modal{ background: rgba(255,255,255,.92); }
    .modalHeader{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:8px 8px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      margin-bottom:12px;
    }
    [data-theme="light"] .modalHeader{ border-bottom-color: rgba(0,0,0,.10); }
    .modalHeader h3{ margin:0; color: var(--text); font-size:15px; }
    .modalBody{ padding: 0 8px 8px; }
    .modalActions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; padding: 8px; }

    .divider{ height:1px; background: rgba(255,255,255,.10); margin:12px 0; }
    [data-theme="light"] .divider{ background: rgba(0,0,0,.10); }

    .help{
      display:inline-flex; align-items:center; justify-content:center;
      width:18px; height:18px;
      border-radius:99px;
      border:1px solid var(--stroke);
      background: var(--panel);
      color: var(--muted);
      font-size:12px;
      font-weight:900;
      cursor:help;
    }

    /* Mobile */
    .mobileNav{
      display:none;
      position:fixed;
      left:12px; right:12px; bottom:12px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      border-radius:18px;
      padding:10px;
      gap:10px;
      z-index:40;
    }
    [data-theme="light"] .mobileNav{ background: rgba(255,255,255,.85); }
    .mobileNav button{
      flex:1;
      border:1px solid var(--stroke);
      background: var(--panel);
      color: var(--text);
      padding:10px 10px;
      border-radius:14px;
      font-weight:850;
      font-size:12px;
      cursor:pointer;
    }
    .mobileNav button.active{ border-color: rgba(110,168,255,.62); background: rgba(110,168,255,.12) }

    @media (max-width: 960px){
      .app{ grid-template-columns: 1fr }
      .sidebar{ display:none }
      .mobileNav{ display:flex }
      .main{ padding-bottom: 92px; }
      .split2{ grid-template-columns: 1fr; }
    }

    canvas{ width:100%; height:180px; display:block; }
  </style>
</head>

<body>
  <div class="app" id="appRoot">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">MB</div>
        <div>
          <h1>MilBudget</h1>
          <p>Simple money control for Soldiers & families</p>
        </div>
      </div>

      <div class="chips">
        <div class="chip"><span class="dot" id="chipDot"></span><span id="chipStatus">Ready</span></div>
        <div class="chip">Auto-save</div>
        <div class="chip">Demo v1</div>
      </div>

      <div class="nav" style="margin-top:12px">
        <button class="active" data-tab="dashboard"><span>üè† Dashboard</span><small>overview</small></button>
        <button data-tab="pay"><span>üóìÔ∏è Payday Split</span><small>1st / 15th</small></button>
        <button data-tab="bills"><span>üßæ Bills</span><small>due dates</small></button>
        <button data-tab="debts"><span>üí≥ Debts</span><small>payoff</small></button>
        <button data-tab="goals"><span>üéØ Goals</span><small>savings</small></button>
        <button data-tab="profile"><span>ü™ñ Profile</span><small>pay setup</small></button>
        <button data-tab="settings"><span>‚öôÔ∏è Settings</span><small>export</small></button>
      </div>

      <div class="hint">
        <b>Tomorrow demo tip:</b> click <b>Settings ‚Üí Load Demo Data</b> so your friends can explore instantly.
      </div>

      <div class="sidebarFooter">
        <button class="btn secondary small" id="btnTheme">üåì Theme</button>
        <button class="btn secondary small" id="btnTour">‚ú® Quick tour</button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="titleBlock">
          <h2 id="pageTitle">Dashboard</h2>
          <div class="sub" id="pageSub">A clean overview of your money this month ‚Äî fast.</div>
        </div>
        <div class="toolbar">
          <div class="pill"><span>Status:</span> <strong id="saveStatus">Saved</strong></div>
          <button class="btn secondary" id="btnAddBill">‚ûï Add Bill</button>
          <button class="btn secondary" id="btnAddDebt">‚ûï Add Debt</button>
        </div>
      </div>

      <!-- DASHBOARD -->
      <section id="dashboard" class="section active">
        <div class="grid">
          <div class="card" style="grid-column: span 4;">
            <h3>Monthly Income <span class="tag">take-home</span></h3>
            <div class="metric" id="mIncome">$0.00</div>
            <div class="muted2" id="incomeHint">Set income in Profile.</div>
          </div>

          <div class="card" style="grid-column: span 4;">
            <h3>Total Bills <span class="tag" id="billCount">0 items</span></h3>
            <div class="metric" id="mBills">$0.00</div>
            <div class="muted2" id="billHint">Add bills to get accurate remaining.</div>
          </div>

          <div class="card" style="grid-column: span 4;">
            <h3>Remaining <span class="tag">after plans</span></h3>
            <div class="metric" id="mRemaining">$0.00</div>
            <div class="muted2" id="remainHint">Bills + goals + debt payments.</div>
          </div>

          <div class="card" style="grid-column: span 7;">
            <h3>Allocation Progress <span class="tag" id="allocTag">0%</span></h3>
            <div class="progress"><div class="bar" id="allocBar"></div></div>
            <div style="height:10px"></div>
            <div class="kpiRow">
              <div class="kpi">
                <div class="t">Bills</div>
                <div class="v" id="kBills">$0.00</div>
              </div>
              <div class="kpi">
                <div class="t">Goals</div>
                <div class="v" id="kGoals">$0.00</div>
              </div>
              <div class="kpi">
                <div class="t">Debt Payments</div>
                <div class="v" id="kDebtPay">$0.00</div>
              </div>
            </div>
            <div class="muted" style="margin-top:10px">
              The goal is simple: assign money to what matters, and see what‚Äôs left.
            </div>
          </div>

          <div class="card" style="grid-column: span 5;">
            <h3>Quick Actions</h3>
            <div class="row">
              <button class="btn" id="qaProfile">ü™ñ Setup Profile</button>
              <button class="btn" id="qaPay">üóìÔ∏è Payday Split</button>
              <button class="btn secondary" id="qaBills">üßæ Manage Bills</button>
              <button class="btn secondary" id="qaDebts">üí≥ Manage Debts</button>
              <button class="btn danger" id="qaReset">Reset</button>
            </div>
            <div class="muted" style="margin-top:10px">
              If this is your first time, start with <b>Profile</b>.
            </div>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="split2">
          <div class="card">
            <h3>Visual Breakdown <span class="tag">this month</span></h3>
            <canvas id="pie"></canvas>
            <div class="pillRow" style="margin-top:10px" id="pieLegend"></div>
          </div>

          <div class="card">
            <h3>Next Up <span class="tag">due dates</span></h3>
            <div class="muted" id="nextUp">Add bills to see what hits first.</div>
            <div class="divider"></div>
            <h3>Notes <span class="tag">optional</span></h3>
            <textarea id="notes" placeholder="Example: 'Pay car early if paycheck hits late.'"></textarea>
            <div class="muted2" style="margin-top:8px">Autosaves.</div>
          </div>
        </div>
      </section>

      <!-- PAYDAY SPLIT -->
      <section id="pay" class="section">
        <div class="card">
          <h3>
            Payday Split (1st / 15th)
            <span class="tag" id="payModeTag">Mode: 1st & 15th</span>
          </h3>
          <div class="muted">
            This shows exactly what hits each paycheck. Monthly bills are split 50/50 by default (simple and realistic).
          </div>

          <div style="height:12px"></div>

          <div class="kpiRow">
            <div class="kpi">
              <div class="t">Paycheck #1</div>
              <div class="v" id="p1Income">$0.00</div>
            </div>
            <div class="kpi">
              <div class="t">Paycheck #2</div>
              <div class="v" id="p2Income">$0.00</div>
            </div>
            <div class="kpi">
              <div class="t">Monthly Bills Split</div>
              <div class="v" id="pMonthlySplit">$0.00 / $0.00</div>
            </div>
            <div class="kpi">
              <div class="t">Remaining After Paychecks</div>
              <div class="v" id="pRemainCombined">$0.00</div>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="split2">
            <div class="card" style="box-shadow:none;">
              <h3>Paycheck #1 (1st) <span class="tag" id="p1Tag">Bills due 1st + half monthly</span></h3>
              <div class="muted2" id="p1Summary"></div>
              <div style="height:10px"></div>
              <table class="table">
                <thead><tr><th>Item</th><th>Type</th><th>Amount</th></tr></thead>
                <tbody id="p1Rows"></tbody>
              </table>
              <div class="divider"></div>
              <div class="kpiRow">
                <div class="kpi"><div class="t">Total out</div><div class="v" id="p1Out">$0.00</div></div>
                <div class="kpi"><div class="t">Leftover</div><div class="v" id="p1Left">$0.00</div></div>
              </div>
            </div>

            <div class="card" style="box-shadow:none;">
              <h3>Paycheck #2 (15th) <span class="tag" id="p2Tag">Bills due 15th + half monthly</span></h3>
              <div class="muted2" id="p2Summary"></div>
              <div style="height:10px"></div>
              <table class="table">
                <thead><tr><th>Item</th><th>Type</th><th>Amount</th></tr></thead>
                <tbody id="p2Rows"></tbody>
              </table>
              <div class="divider"></div>
              <div class="kpiRow">
                <div class="kpi"><div class="t">Total out</div><div class="v" id="p2Out">$0.00</div></div>
                <div class="kpi"><div class="t">Leftover</div><div class="v" id="p2Left">$0.00</div></div>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="row">
            <button class="btn secondary" id="btnGoBills">üßæ Add/Adjust Bills</button>
            <button class="btn secondary" id="btnGoProfile">ü™ñ Adjust Pay</button>
          </div>
        </div>
      </section>

      <!-- BILLS -->
      <section id="bills" class="section">
        <div class="card">
          <h3>
            Bills
            <span class="tag">rent, car, insurance, subscriptions</span>
          </h3>

          <div class="row">
            <div class="field">
              <label>Bill name</label>
              <input id="billName" placeholder="Rent, Car Payment, Phone..." />
            </div>
            <div class="field">
              <label>Amount</label>
              <input id="billAmount" type="number" min="0" step="0.01" placeholder="975" />
            </div>
            <div class="field">
              <label>Due date</label>
              <select id="billDue">
                <option value="1st">1st</option>
                <option value="15th">15th</option>
                <option value="monthly">Monthly (flex)</option>
              </select>
            </div>
            <div class="field">
              <label>Category</label>
              <select id="billCat">
                <option value="Housing">Housing</option>
                <option value="Transportation">Transportation</option>
                <option value="Insurance">Insurance</option>
                <option value="Utilities">Utilities</option>
                <option value="Subscriptions">Subscriptions</option>
                <option value="Phone/Internet">Phone/Internet</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="row">
            <button class="btn" id="addBill">‚ûï Add Bill</button>
            <button class="btn secondary" id="clearBillInputs">Clear</button>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="field">
              <label>Search</label>
              <input id="billSearch" placeholder="Type to filter (rent, car, etc.)" />
            </div>
            <div class="field">
              <label>Sort</label>
              <select id="billSort">
                <option value="due">Due date</option>
                <option value="amountDesc">Amount (high ‚Üí low)</option>
                <option value="amountAsc">Amount (low ‚Üí high)</option>
                <option value="name">Name</option>
                <option value="cat">Category</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>

          <table class="table">
            <thead>
              <tr>
                <th>Bill</th>
                <th>Category</th>
                <th>Due</th>
                <th>Amount</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="billRows"></tbody>
          </table>

          <div class="muted2" style="margin-top:10px">
            Tip: ‚ÄúMonthly (flex)‚Äù bills are split 50/50 across paychecks in the Payday Split view.
          </div>
        </div>
      </section>

      <!-- DEBTS -->
      <section id="debts" class="section">
        <div class="card">
          <h3>
            Debts
            <span class="tag">payments & payoff estimate</span>
          </h3>

          <div class="row">
            <div class="field">
              <label>Debt name</label>
              <input id="debtName" placeholder="Camry Loan, Credit Card..." />
            </div>
            <div class="field">
              <label>Balance</label>
              <input id="debtBal" type="number" min="0" step="0.01" placeholder="8000" />
            </div>
            <div class="field">
              <label>APR % <span class="help" title="Used for payoff estimate. If you don‚Äôt know, set 0.">?</span></label>
              <input id="debtApr" type="number" min="0" step="0.01" placeholder="6.00" />
            </div>
            <div class="field">
              <label>Monthly payment</label>
              <input id="debtPay" type="number" min="0" step="0.01" placeholder="502" />
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="row">
            <button class="btn" id="addDebt">‚ûï Add Debt</button>
            <button class="btn secondary" id="clearDebtInputs">Clear</button>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="field">
              <label>Extra monthly paydown (applies to highest APR first)</label>
              <input id="extraDebt" type="number" min="0" step="0.01" placeholder="0" />
            </div>
            <div class="field">
              <label>Payoff strategy</label>
              <select id="debtStrategy">
                <option value="avalanche">Avalanche (highest APR)</option>
                <option value="snowball">Snowball (smallest balance)</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="kpiRow">
            <div class="kpi"><div class="t">Total debt</div><div class="v" id="debtTotal">$0.00</div></div>
            <div class="kpi"><div class="t">Total monthly payments</div><div class="v" id="debtMonthly">$0.00</div></div>
            <div class="kpi"><div class="t">Estimated payoff time</div><div class="v" id="debtPayoff">‚Äî</div></div>
          </div>

          <div style="height:12px"></div>

          <table class="table">
            <thead>
              <tr>
                <th>Debt</th>
                <th>Balance</th>
                <th>APR</th>
                <th>Payment</th>
                <th>Est. months</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="debtRows"></tbody>
          </table>

          <div class="muted2" style="margin-top:10px">
            Note: payoff is an estimate using a simple interest model (good enough for a demo & planning).
          </div>
        </div>
      </section>

      <!-- GOALS -->
      <section id="goals" class="section">
        <div class="card">
          <h3>
            Goals
            <span class="tag">savings + spending buckets</span>
          </h3>

          <div class="row">
            <div class="field">
              <label>Emergency fund (monthly)</label>
              <input id="gEmergency" type="number" min="0" step="0.01" placeholder="200" />
            </div>
            <div class="field">
              <label>Investing (monthly)</label>
              <input id="gInvest" type="number" min="0" step="0.01" placeholder="100" />
            </div>
            <div class="field">
              <label>Fun money (monthly)</label>
              <input id="gFun" type="number" min="0" step="0.01" placeholder="150" />
            </div>
            <div class="field">
              <label>Groceries (monthly)</label>
              <input id="gGroc" type="number" min="0" step="0.01" placeholder="300" />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <button class="btn" id="saveGoals">üíæ Save Goals</button>
            <button class="btn secondary" id="zeroGoals">Zero All</button>
          </div>

          <div class="divider"></div>

          <div class="kpiRow">
            <div class="kpi"><div class="t">Goals total</div><div class="v" id="goalsTotal">$0.00</div></div>
            <div class="kpi"><div class="t">Suggested savings rate</div><div class="v" id="saveRate">‚Äî</div></div>
            <div class="kpi"><div class="t">Left after goals</div><div class="v" id="leftAfterGoals">$0.00</div></div>
          </div>

          <div class="muted" style="margin-top:10px">
            These buckets make the app feel ‚Äúreal‚Äù and help users plan beyond bills.
          </div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="profile" class="section">
        <div class="card">
          <h3>
            Profile / Pay Setup
            <span class="tag">manual + optional rank helper</span>
          </h3>

          <div class="muted">
            For the demo, you can keep it simple: set your <b>monthly take-home</b> and pay schedule.
          </div>

          <div style="height:12px"></div>

          <div class="row">
            <div class="field">
              <label>Pay schedule</label>
              <select id="paySchedule">
                <option value="monthly">Monthly</option>
                <option value="1st15th">1st & 15th</option>
              </select>
            </div>
            <div class="field">
              <label>Monthly take-home income</label>
              <input id="incomeMonthly" type="number" min="0" step="0.01" placeholder="4200" />
            </div>
            <div class="field">
              <label>Optional: Rank helper (demo)</label>
              <select id="rank">
                <option value="">‚Äî Select ‚Äî</option>
                <option value="E1">E-1</option><option value="E2">E-2</option><option value="E3">E-3</option>
                <option value="E4">E-4</option><option value="E5">E-5</option><option value="E6">E-6</option>
                <option value="E7">E-7</option><option value="E8">E-8</option><option value="E9">E-9</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <div class="field">
              <label>Optional: Monthly BAS (manual)</label>
              <input id="bas" type="number" min="0" step="0.01" placeholder="460" />
            </div>
            <div class="field">
              <label>Optional: Monthly BAH (manual)</label>
              <input id="bah" type="number" min="0" step="0.01" placeholder="1600" />
            </div>
            <div class="field">
              <label>Optional: Base pay (manual)</label>
              <input id="basePay" type="number" min="0" step="0.01" placeholder="2300" />
            </div>
            <div class="field">
              <label>Calculated monthly total <span class="help" title="If you use Base+BAH+BAS, we‚Äôll show the total. Your take-home is still the main number.">?</span></label>
              <input id="calcTotal" disabled />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <button class="btn" id="saveProfile">üíæ Save Profile</button>
            <button class="btn secondary" id="applyRank">ü™ñ Auto-fill base pay (demo)</button>
          </div>

          <div class="muted2" style="margin-top:10px">
            Next version: real pay tables + duty station BAH lookup.
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="settings" class="section">
        <div class="card">
          <h3>
            Settings / Share
            <span class="tag">export ‚Ä¢ import ‚Ä¢ demo</span>
          </h3>

          <div class="row">
            <button class="btn secondary" id="btnExport">üì§ Export Data</button>
            <button class="btn secondary" id="btnImport">üì• Import Data</button>
            <button class="btn" id="btnDemo">‚ú® Load Demo Data</button>
            <button class="btn danger" id="btnWipe">üß® Wipe Everything</button>
            <button class="btn secondary" id="btnPrint">üñ®Ô∏è Print Summary</button>
          </div>

          <div class="divider"></div>

          <h3>What to ask your friends tomorrow</h3>
          <div class="muted">
            1) Is the flow easy? (Profile ‚Üí Bills ‚Üí Payday Split)<br/>
            2) What features would make you pay $2‚Äì$5/month?<br/>
            3) What‚Äôs missing for military life? (PCS, deployment, SCRA, TSP, etc.)<br/>
            4) What screen is confusing?
          </div>

          <div class="divider"></div>

          <h3>Feedback Notes (for you)</h3>
          <textarea id="feedbackNotes" placeholder="Type what your friends say‚Ä¶ this saves here."></textarea>
        </div>
      </section>

      <div class="toast" id="toast"></div>
    </main>
  </div>

  <!-- Mobile Nav -->
  <div class="mobileNav" id="mobileNav">
    <button class="active" data-tab="dashboard">üè†</button>
    <button data-tab="pay">üóìÔ∏è</button>
    <button data-tab="bills">üßæ</button>
    <button data-tab="debts">üí≥</button>
    <button data-tab="profile">ü™ñ</button>
  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <h3 id="modalTitle">Modal</h3>
        <button class="btn secondary small" id="modalClose">‚úï</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalActions" id="modalActions"></div>
    </div>
  </div>

  <script>
    // ============
    // MilBudget v1 - single file demo
    // ============

    const KEY = "milbudget_full_v1";
    const $ = (id)=>document.getElementById(id);
    const fmt = (n)=> (Number(n||0)).toLocaleString(undefined,{style:"currency", currency:"USD"});
    const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));
    const nowISO = ()=> new Date().toISOString();

    const state = load() || {
      meta: { created: nowISO(), updated: nowISO() },
      theme: "dark",
      notes: "",
      feedbackNotes: "",
      profile: {
        paySchedule: "1st15th",
        monthlyIncome: 0, // take-home main number
        rank: "",
        basePay: 0,
        bah: 0,
        bas: 0
      },
      bills: [],
      debts: [],
      goals: { emergency:0, invest:0, fun:0, groceries:0 },
      debtPlan: { extra:0, strategy:"avalanche" }
    };

    function load(){
      try{ const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : null; }
      catch(e){ return null; }
    }
    function save(){
      state.meta.updated = nowISO();
      localStorage.setItem(KEY, JSON.stringify(state));
      pulseSaved();
    }

    // ---- UI helpers
    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1500);
    }
    function pulseSaved(){
      const s = $("saveStatus");
      s.textContent = "Saved ‚úì";
      setTimeout(()=>{ s.textContent = "Saved"; }, 800);
    }
    function setTheme(theme){
      state.theme = theme;
      document.documentElement.setAttribute("data-theme", theme === "light" ? "light" : "dark");
      save();
      toast(theme === "light" ? "Light mode" : "Dark mode");
      renderAll();
    }

    // ---- Navigation
    const sections = ["dashboard","pay","bills","debts","goals","profile","settings"];
    function setTab(tab){
      sections.forEach(id => $(id).classList.toggle("active", id===tab));
      document.querySelectorAll(".nav button").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
      document.querySelectorAll("#mobileNav button").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));

      const titles = {
        dashboard:["Dashboard","A clean overview of your money this month ‚Äî fast."],
        pay:["Payday Split","See what hits each paycheck (1st / 15th)."],
        bills:["Bills","Manage due dates and totals."],
        debts:["Debts","Track payments & payoff estimates."],
        goals:["Goals","Buckets for saving + spending."],
        profile:["Profile","Set your pay + schedule."],
        settings:["Settings","Export, import, demo data, and printing."]
      };
      $("pageTitle").textContent = titles[tab][0];
      $("pageSub").textContent = titles[tab][1];

      renderAll();
      window.scrollTo({top:0, behavior:"smooth"});
    }

    document.querySelectorAll(".nav button").forEach(b=>b.addEventListener("click", ()=>setTab(b.dataset.tab)));
    document.querySelectorAll("#mobileNav button").forEach(b=>b.addEventListener("click", ()=>setTab(b.dataset.tab)));

    // ---- Calculations
    function billsTotal(){
      return state.bills.reduce((a,b)=>a+Number(b.amount||0),0);
    }
    function debtMonthlyTotal(){
      return state.debts.reduce((a,d)=>a+Number(d.payment||0),0);
    }
    function goalsTotal(){
      const g = state.goals;
      return Number(g.emergency||0)+Number(g.invest||0)+Number(g.fun||0)+Number(g.groceries||0);
    }
    function monthlyIncome(){
      return Number(state.profile.monthlyIncome||0);
    }
    function remaining(){
      return monthlyIncome() - (billsTotal()+goalsTotal()+debtMonthlyTotal());
    }

    // Payday split logic:
    // - If pay schedule is 1st/15th: income split 50/50.
    // - Bills due 1st -> paycheck 1, due 15th -> paycheck 2
    // - Bills monthly -> split 50/50
    // - Debt payments + goals split 50/50 (simple)
    function paydaySplit(){
      const inc = monthlyIncome();
      const p1inc = inc/2;
      const p2inc = inc/2;

      const monthlyBills = state.bills.filter(b=>b.due==="monthly");
      const b1 = state.bills.filter(b=>b.due==="1st");
      const b2 = state.bills.filter(b=>b.due==="15th");
      const monthlyHalf = monthlyBills.reduce((a,b)=>a+Number(b.amount||0),0)/2;

      const p1Bills = b1.reduce((a,b)=>a+Number(b.amount||0),0) + monthlyHalf;
      const p2Bills = b2.reduce((a,b)=>a+Number(b.amount||0),0) + monthlyHalf;

      const gHalf = goalsTotal()/2;
      const dHalf = debtMonthlyTotal()/2;

      const p1Out = p1Bills + gHalf + dHalf;
      const p2Out = p2Bills + gHalf + dHalf;

      return {
        p1inc, p2inc,
        monthlyHalf,
        p1Bills, p2Bills,
        gHalf, dHalf,
        p1Out, p2Out,
        p1Left: p1inc - p1Out,
        p2Left: p2inc - p2Out
      };
    }

    // Simple payoff estimate months:
    // Uses monthly interest approximation and simulates months.
    function estimatePayoffMonths(balance, apr, payment){
      balance = Number(balance||0);
      apr = Number(apr||0);
      payment = Number(payment||0);
      if(balance <= 0) return 0;
      if(payment <= 0) return Infinity;
      const r = (apr/100)/12;
      let months = 0;
      let b = balance;
      while(b > 0 && months < 1000){
        const interest = b * r;
        b = b + interest - payment;
        months++;
        if(payment <= interest && r > 0) return Infinity;
      }
      return months >= 1000 ? Infinity : months;
    }

    // Debt plan simulation (avalanche/snowball) for overall estimate
    function estimateTotalPayoff(){
      if(state.debts.length === 0) return "‚Äî";
      const extra = Number(state.debtPlan.extra||0);
      const strat = state.debtPlan.strategy || "avalanche";

      // Clone debts
      let debts = state.debts.map(d=>({
        name:d.name,
        bal:Number(d.balance||0),
        apr:Number(d.apr||0),
        pay:Number(d.payment||0)
      })).filter(d=>d.bal>0);

      if(debts.length===0) return "0 months";

      let months = 0;
      while(debts.some(d=>d.bal>0) && months < 1200){
        // Pick target
        debts = debts.filter(d=>d.bal>0);
        debts.sort((a,b)=>{
          if(strat==="snowball") return a.bal - b.bal;
          // avalanche
          return b.apr - a.apr || b.bal - a.bal;
        });
        const target = debts[0];

        // Apply one month
        for(const d of debts){
          const r = (d.apr/100)/12;
          const interest = d.bal * r;
          d.bal += interest;
          let pay = d.pay;
          if(d===target) pay += extra;
          d.bal -= pay;
        }
        months++;
      }
      if(months>=1200) return "1200+ months";
      return months + " months";
    }

    // ---- Rendering
    function renderStatusChip(){
      const rem = remaining();
      const dot = $("chipDot");
      const text = $("chipStatus");
      if(monthlyIncome() <= 0){
        dot.className = "dot warn";
        text.textContent = "Set income";
        return;
      }
      if(rem >= 200){
        dot.className = "dot good";
        text.textContent = "Healthy";
      } else if(rem >= 0){
        dot.className = "dot warn";
        text.textContent = "Tight";
      } else {
        dot.className = "dot bad";
        text.textContent = "Over budget";
      }
    }

    function renderDashboard(){
      const inc = monthlyIncome();
      const b = billsTotal();
      const g = goalsTotal();
      const d = debtMonthlyTotal();
      const rem = remaining();

      $("mIncome").textContent = fmt(inc);
      $("mBills").textContent = fmt(b);
      $("mRemaining").textContent = fmt(rem);

      $("mRemaining").classList.toggle("good", rem >= 0);
      $("mRemaining").classList.toggle("bad", rem < 0);

      $("kBills").textContent = fmt(b);
      $("kGoals").textContent = fmt(g);
      $("kDebtPay").textContent = fmt(d);

      $("billCount").textContent = `${state.bills.length} items`;

      $("incomeHint").textContent = inc>0 ? `Schedule: ${state.profile.paySchedule==="1st15th"?"1st & 15th":"Monthly"}` : "Set income in Profile.";
      $("billHint").textContent = state.bills.length ? "Bills loaded." : "Add bills to get accurate remaining.";

      const alloc = b+g+d;
      const pct = inc>0 ? clamp((alloc/inc)*100, 0, 140) : 0;
      $("allocTag").textContent = (inc>0 ? pct.toFixed(0) : 0) + "%";
      $("allocBar").style.width = clamp(pct,0,100).toFixed(0) + "%";

      // Next up bills (sorted)
      const order = { "1st":1, "15th":2, "monthly":3 };
      const sorted = [...state.bills].sort((x,y)=> (order[x.due]-order[y.due]) || (y.amount-x.amount) || x.name.localeCompare(y.name));
      if(sorted.length===0){
        $("nextUp").textContent = "Add bills to see what hits first.";
      } else {
        const top = sorted.slice(0,6).map(b=>(
          `<div style="display:flex;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.10)">
            <div><b>${escapeHtml(b.name)}</b> <span class="tag">${labelDue(b.due)}</span> <span class="tag">${escapeHtml(b.category||"Other")}</span></div>
            <div>${fmt(b.amount)}</div>
          </div>`
        )).join("");
        $("nextUp").innerHTML = top + (sorted.length>6 ? `<div class="muted2" style="padding-top:10px">+${sorted.length-6} more</div>` : "");
      }

      // Notes
      $("notes").value = state.notes || "";
      $("feedbackNotes").value = state.feedbackNotes || "";

      renderPie();
      renderStatusChip();
    }

    function renderPay(){
      const mode = state.profile.paySchedule || "1st15th";
      $("payModeTag").textContent = "Mode: " + (mode==="1st15th" ? "1st & 15th" : "Monthly");
      const inc = monthlyIncome();
      if(inc <= 0){
        $("p1Income").textContent = fmt(0);
        $("p2Income").textContent = fmt(0);
        $("pMonthlySplit").textContent = fmt(0) + " / " + fmt(0);
        $("pRemainCombined").textContent = fmt(0);
        $("p1Rows").innerHTML = `<tr><td colspan="3" class="muted">Set income in Profile.</td></tr>`;
        $("p2Rows").innerHTML = `<tr><td colspan="3" class="muted">Set income in Profile.</td></tr>`;
        return;
      }

      // If monthly mode, still show split as a planning tool.
      const s = paydaySplit();
      $("p1Income").textContent = fmt(s.p1inc);
      $("p2Income").textContent = fmt(s.p2inc);
      $("pMonthlySplit").textContent = fmt(s.monthlyHalf) + " / " + fmt(s.monthlyHalf);
      $("pRemainCombined").textContent = fmt(s.p1Left + s.p2Left);

      $("p1Out").textContent = fmt(s.p1Out);
      $("p2Out").textContent = fmt(s.p2Out);
      $("p1Left").textContent = fmt(s.p1Left);
      $("p2Left").textContent = fmt(s.p2Left);

      $("p1Left").style.color = s.p1Left>=0 ? "var(--good)" : "var(--bad)";
      $("p2Left").style.color = s.p2Left>=0 ? "var(--good)" : "var(--bad)";
      $("pRemainCombined").style.color = (s.p1Left+s.p2Left)>=0 ? "var(--good)" : "var(--bad)";

      $("p1Summary").textContent = `Includes 1st bills + half of monthly bills + half goals + half debt payments.`;
      $("p2Summary").textContent = `Includes 15th bills + half of monthly bills + half goals + half debt payments.`;

      const monthlyBills = state.bills.filter(b=>b.due==="monthly");
      const b1 = state.bills.filter(b=>b.due==="1st");
      const b2 = state.bills.filter(b=>b.due==="15th");

      const halfMonthlyItems = monthlyBills.map(b=>({name:b.name, type:"Monthly (half)", amount:Number(b.amount||0)/2}));
      const gHalf = goalsTotal()/2;
      const dHalf = debtMonthlyTotal()/2;

      const p1Items = [
        ...b1.map(b=>({name:b.name, type:"Bill (1st)", amount:Number(b.amount||0)})),
        ...halfMonthlyItems,
        ...(gHalf>0 ? [{name:"Goals (half)", type:"Goals", amount:gHalf}] : []),
        ...(dHalf>0 ? [{name:"Debt payments (half)", type:"Debt", amount:dHalf}] : [])
      ];
      const p2Items = [
        ...b2.map(b=>({name:b.name, type:"Bill (15th)", amount:Number(b.amount||0)})),
        ...halfMonthlyItems,
        ...(gHalf>0 ? [{name:"Goals (half)", type:"Goals", amount:gHalf}] : []),
        ...(dHalf>0 ? [{name:"Debt payments (half)", type:"Debt", amount:dHalf}] : [])
      ];

      $("p1Rows").innerHTML = p1Items.length
        ? p1Items.map(i=>row3(i.name, i.type, i.amount)).join("")
        : `<tr><td colspan="3" class="muted">No items for Paycheck #1 yet.</td></tr>`;

      $("p2Rows").innerHTML = p2Items.length
        ? p2Items.map(i=>row3(i.name, i.type, i.amount)).join("")
        : `<tr><td colspan="3" class="muted">No items for Paycheck #2 yet.</td></tr>`;
    }

    function row3(a,b,c){
      return `<tr><td><b>${escapeHtml(a)}</b></td><td><span class="tag">${escapeHtml(b)}</span></td><td>${fmt(c)}</td></tr>`;
    }

    function labelDue(d){
      if(d==="1st") return "Due 1st";
      if(d==="15th") return "Due 15th";
      return "Monthly";
    }

    function renderBills(){
      const search = ($("billSearch").value || "").trim().toLowerCase();
      const sort = $("billSort").value || "due";
      const order = { "1st":1, "15th":2, "monthly":3 };

      let list = [...state.bills];

      if(search){
        list = list.filter(b =>
          (b.name||"").toLowerCase().includes(search) ||
          (b.category||"").toLowerCase().includes(search) ||
          (b.due||"").toLowerCase().includes(search)
        );
      }

      list.sort((a,b)=>{
        if(sort==="due") return (order[a.due]-order[b.due]) || (b.amount-a.amount);
        if(sort==="amountDesc") return (b.amount-a.amount) || (order[a.due]-order[b.due]);
        if(sort==="amountAsc") return (a.amount-b.amount) || (order[a.due]-order[b.due]);
        if(sort==="name") return (a.name||"").localeCompare(b.name||"");
        if(sort==="cat") return (a.category||"").localeCompare(b.category||"");
        return 0;
      });

      const rows = $("billRows");
      if(list.length===0){
        rows.innerHTML = `<tr><td colspan="5" class="muted">No bills found. Add one above.</td></tr>`;
      } else {
        rows.innerHTML = list.map((b)=>{
          return `
            <tr>
              <td><b>${escapeHtml(b.name)}</b></td>
              <td><span class="tag">${escapeHtml(b.category||"Other")}</span></td>
              <td><span class="tag">${labelDue(b.due)}</span></td>
              <td>${fmt(b.amount)}</td>
              <td style="text-align:right">
                <button class="btn small secondary" onclick="editBill('${b.id}')">Edit</button>
                <button class="btn small danger" onclick="delBill('${b.id}')">Delete</button>
              </td>
            </tr>
          `;
        }).join("");
      }
    }

    function renderDebts(){
      // totals
      const total = state.debts.reduce((a,d)=>a+Number(d.balance||0),0);
      const monthly = debtMonthlyTotal();
      $("debtTotal").textContent = fmt(total);
      $("debtMonthly").textContent = fmt(monthly);
      $("debtPayoff").textContent = estimateTotalPayoff();

      // inputs reflect plan
      $("extraDebt").value = state.debtPlan.extra ?? 0;
      $("debtStrategy").value = state.debtPlan.strategy || "avalanche";

      const rows = $("debtRows");
      if(state.debts.length===0){
        rows.innerHTML = `<tr><td colspan="6" class="muted">No debts yet. Add one above.</td></tr>`;
      } else {
        rows.innerHTML = state.debts.map(d=>{
          const months = estimatePayoffMonths(d.balance, d.apr, d.payment);
          const mText = (months===Infinity) ? "‚àû" : String(months);
          return `
            <tr>
              <td><b>${escapeHtml(d.name)}</b></td>
              <td>${fmt(d.balance)}</td>
              <td>${Number(d.apr||0).toFixed(2)}%</td>
              <td>${fmt(d.payment)}</td>
              <td><span class="tag">${mText}</span></td>
              <td style="text-align:right">
                <button class="btn small secondary" onclick="editDebt('${d.id}')">Edit</button>
                <button class="btn small danger" onclick="delDebt('${d.id}')">Delete</button>
              </td>
            </tr>
          `;
        }).join("");
      }
    }

    function renderGoals(){
      const g = state.goals;
      $("gEmergency").value = g.emergency ?? 0;
      $("gInvest").value = g.invest ?? 0;
      $("gFun").value = g.fun ?? 0;
      $("gGroc").value = g.groceries ?? 0;

      const gt = goalsTotal();
      $("goalsTotal").textContent = fmt(gt);

      const inc = monthlyIncome();
      const suggested = inc>0 ? (gt/inc)*100 : 0;
      $("saveRate").textContent = inc>0 ? suggested.toFixed(0) + "% of income" : "‚Äî";

      const left = monthlyIncome() - (billsTotal()+debtMonthlyTotal()+gt);
      $("leftAfterGoals").textContent = fmt(left);
      $("leftAfterGoals").style.color = left>=0 ? "var(--good)" : "var(--bad)";
    }

    function renderProfile(){
      $("paySchedule").value = state.profile.paySchedule || "1st15th";
      $("incomeMonthly").value = state.profile.monthlyIncome ?? 0;
      $("rank").value = state.profile.rank || "";
      $("basePay").value = state.profile.basePay ?? 0;
      $("bah").value = state.profile.bah ?? 0;
      $("bas").value = state.profile.bas ?? 0;

      const calc = Number(state.profile.basePay||0) + Number(state.profile.bah||0) + Number(state.profile.bas||0);
      $("calcTotal").value = calc>0 ? fmt(calc) : "";
    }

    function renderAll(){
      renderDashboard();
      renderPay();
      renderBills();
      renderDebts();
      renderGoals();
      renderProfile();
      renderStatusChip();
    }

    // ---- Pie chart (canvas)
    function renderPie(){
      const canvas = $("pie");
      const ctx = canvas.getContext("2d");

      // handle retina scaling
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(180 * dpr);
      ctx.scale(dpr, dpr);

      const inc = monthlyIncome();
      const b = billsTotal();
      const g = goalsTotal();
      const d = debtMonthlyTotal();
      const rem = Math.max(0, remaining());

      const parts = [
        {name:"Bills", val:b},
        {name:"Goals", val:g},
        {name:"Debt", val:d},
        {name:"Remaining", val:rem}
      ];
      const total = parts.reduce((a,p)=>a+p.val,0);

      // Background ring
      ctx.clearRect(0,0,rect.width,180);
      const cx = rect.width/2;
      const cy = 90;
      const r = 62;

      // Soft shadow circle
      ctx.beginPath();
      ctx.arc(cx,cy,r+8,0,Math.PI*2);
      ctx.fillStyle = "rgba(0,0,0,.08)";
      ctx.fill();

      // If no data
      if(total <= 0){
        ctx.beginPath();
        ctx.arc(cx,cy,r,0,Math.PI*2);
        ctx.fillStyle = "rgba(255,255,255,.08)";
        ctx.fill();
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
        ctx.font = "800 12px ui-sans-serif, system-ui";
        ctx.textAlign = "center";
        ctx.fillText("Add income to see chart", cx, cy+4);
        $("pieLegend").innerHTML = `<span class="tag">No data</span>`;
        return;
      }

      const colors = [
        "rgba(110,168,255,.95)", // bills
        "rgba(70,255,175,.92)",  // goals
        "rgba(255,208,112,.95)", // debt
        "rgba(255,255,255,.20)"  // remaining
      ];

      let start = -Math.PI/2;
      parts.forEach((p,i)=>{
        const angle = (p.val/total)*Math.PI*2;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,start,start+angle);
        ctx.closePath();
        ctx.fillStyle = colors[i];
        ctx.fill();
        start += angle;
      });

      // donut hole
      ctx.beginPath();
      ctx.arc(cx,cy,38,0,Math.PI*2);
      ctx.fillStyle = "rgba(0,0,0,.22)";
      if(document.documentElement.getAttribute("data-theme")==="light"){
        ctx.fillStyle = "rgba(255,255,255,.88)";
      }
      ctx.fill();

      // center text
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text');
      ctx.font = "900 14px ui-sans-serif, system-ui";
      ctx.textAlign = "center";
      ctx.fillText("Income", cx, cy-4);
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
      ctx.font = "900 12px ui-sans-serif, system-ui";
      ctx.fillText(fmt(inc), cx, cy+16);

      // legend
      const leg = parts.map((p,i)=>{
        const pct = (p.val/total)*100;
        return `<span class="tag"><span style="width:10px;height:10px;border-radius:99px;background:${colors[i]};display:inline-block"></span>${p.name}: ${pct.toFixed(0)}%</span>`;
      }).join(" ");
      $("pieLegend").innerHTML = leg;
    }

    // ---- Escape
    function escapeHtml(str){
      return String(str||"").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    // ---- Bills CRUD
    function uuid(){
      return Math.random().toString(16).slice(2) + "-" + Math.random().toString(16).slice(2);
    }
    window.delBill = (id)=>{
      state.bills = state.bills.filter(b=>b.id!==id);
      save(); renderAll(); toast("Bill deleted");
    }
    window.editBill = (id)=>{
      const b = state.bills.find(x=>x.id===id);
      if(!b) return;
      openModal("Edit Bill", `
        <div class="row">
          <div class="field"><label>Name</label><input id="mb_name" value="${escapeHtml(b.name)}"></div>
          <div class="field"><label>Amount</label><input id="mb_amt" type="number" step="0.01" value="${Number(b.amount||0)}"></div>
          <div class="field"><label>Due</label>
            <select id="mb_due">
              <option value="1st">1st</option>
              <option value="15th">15th</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
          <div class="field"><label>Category</label>
            <select id="mb_cat">
              <option>Housing</option><option>Transportation</option><option>Insurance</option>
              <option>Utilities</option><option>Subscriptions</option><option>Phone/Internet</option>
              <option>Other</option>
            </select>
          </div>
        </div>
        <div class="muted2" style="margin-top:10px">Tip: Monthly bills split 50/50 in Payday Split.</div>
      `, [
        {label:"Cancel", kind:"secondary", onClick: closeModal},
        {label:"Save", kind:"", onClick: ()=>{
          b.name = $("mb_name").value.trim() || b.name;
          b.amount = Number($("mb_amt").value||0);
          b.due = $("mb_due").value;
          b.category = $("mb_cat").value;
          save(); closeModal(); renderAll(); toast("Bill updated");
        }}
      ], ()=>{
        $("mb_due").value = b.due;
        $("mb_cat").value = b.category || "Other";
      });
    }

    // ---- Debts CRUD
    window.delDebt = (id)=>{
      state.debts = state.debts.filter(d=>d.id!==id);
      save(); renderAll(); toast("Debt deleted");
    }
    window.editDebt = (id)=>{
      const d = state.debts.find(x=>x.id===id);
      if(!d) return;
      openModal("Edit Debt", `
        <div class="row">
          <div class="field"><label>Name</label><input id="md_name" value="${escapeHtml(d.name)}"></div>
          <div class="field"><label>Balance</label><input id="md_bal" type="number" step="0.01" value="${Number(d.balance||0)}"></div>
          <div class="field"><label>APR %</label><input id="md_apr" type="number" step="0.01" value="${Number(d.apr||0)}"></div>
          <div class="field"><label>Payment (monthly)</label><input id="md_pay" type="number" step="0.01" value="${Number(d.payment||0)}"></div>
        </div>
      `, [
        {label:"Cancel", kind:"secondary", onClick: closeModal},
        {label:"Save", kind:"", onClick: ()=>{
          d.name = $("md_name").value.trim() || d.name;
          d.balance = Number($("md_bal").value||0);
          d.apr = Number($("md_apr").value||0);
          d.payment = Number($("md_pay").value||0);
          save(); closeModal(); renderAll(); toast("Debt updated");
        }}
      ]);
    }

    // ---- Modal framework
    function openModal(title, bodyHTML, actions=[], afterOpen){
      $("modalTitle").textContent = title;
      $("modalBody").innerHTML = bodyHTML;

      const act = $("modalActions");
      act.innerHTML = "";
      actions.forEach(a=>{
        const btn = document.createElement("button");
        btn.className = "btn " + (a.kind || "");
        btn.textContent = a.label;
        btn.addEventListener("click", a.onClick);
        act.appendChild(btn);
      });

      $("modalBack").style.display = "flex";
      if(afterOpen) setTimeout(afterOpen, 0);
    }
    function closeModal(){ $("modalBack").style.display = "none"; }
    $("modalClose").addEventListener("click", closeModal);
    $("modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });

    // ---- Events / Actions
    $("btnTheme").addEventListener("click", ()=>{
      setTheme(state.theme==="light" ? "dark" : "light");
    });

    $("btnTour").addEventListener("click", ()=>{
      openModal("Quick Tour ‚ú®", `
        <div class="muted">
          <b>1)</b> Go to <b>Profile</b> and set monthly take-home + pay schedule.<br/><br/>
          <b>2)</b> Add your <b>Bills</b> (rent, cars, insurance, phone).<br/><br/>
          <b>3)</b> Check <b>Payday Split</b> to see what hits each paycheck.<br/><br/>
          <b>4)</b> Add <b>Debts</b> to track payments and payoff estimates.<br/><br/>
          <b>5)</b> Set <b>Goals</b> for savings and spending buckets.
        </div>
      `, [{label:"Got it", kind:"", onClick: closeModal}]);
    });

    // Quick actions
    $("qaProfile").addEventListener("click", ()=>setTab("profile"));
    $("qaPay").addEventListener("click", ()=>setTab("pay"));
    $("qaBills").addEventListener("click", ()=>setTab("bills"));
    $("qaDebts").addEventListener("click", ()=>setTab("debts"));
    $("qaReset").addEventListener("click", ()=>{
      openModal("Reset MilBudget?", `<div class="muted">This clears your local demo data.</div>`, [
        {label:"Cancel", kind:"secondary", onClick: closeModal},
        {label:"Reset", kind:"danger", onClick: ()=>{
          localStorage.removeItem(KEY);
          location.reload();
        }}
      ]);
    });

    // Notes autosave
    $("notes").addEventListener("input", ()=>{
      state.notes = $("notes").value;
      save();
    });
    $("feedbackNotes").addEventListener("input", ()=>{
      state.feedbackNotes = $("feedbackNotes").value;
      save();
    });

    // Toolbar quick add
    $("btnAddBill").addEventListener("click", ()=>setTab("bills"));
    $("btnAddDebt").addEventListener("click", ()=>setTab("debts"));

    // Payday page navigation buttons
    $("btnGoBills").addEventListener("click", ()=>setTab("bills"));
    $("btnGoProfile").addEventListener("click", ()=>setTab("profile"));

    // Bills
    $("addBill").addEventListener("click", ()=>{
      const name = $("billName").value.trim();
      const amount = Number($("billAmount").value||0);
      const due = $("billDue").value;
      const category = $("billCat").value;
      if(!name){ toast("Add a bill name"); return; }
      if(!(amount>0)){ toast("Enter a valid amount"); return; }

      state.bills.push({ id: uuid(), name, amount, due, category });
      $("billName").value = "";
      $("billAmount").value = "";
      $("billDue").value = "1st";
      $("billCat").value = "Housing";

      save(); renderAll(); toast("Bill added");
    });
    $("clearBillInputs").addEventListener("click", ()=>{
      $("billName").value=""; $("billAmount").value="";
      $("billDue").value="1st"; $("billCat").value="Housing";
    });
    $("billSearch").addEventListener("input", renderBills);
    $("billSort").addEventListener("change", renderBills);

    // Debts
    $("addDebt").addEventListener("click", ()=>{
      const name = $("debtName").value.trim();
      const balance = Number($("debtBal").value||0);
      const apr = Number($("debtApr").value||0);
      const payment = Number($("debtPay").value||0);
      if(!name){ toast("Add a debt name"); return; }
      if(!(balance>0)){ toast("Enter a valid balance"); return; }
      if(!(payment>=0)){ toast("Enter a valid payment"); return; }

      state.debts.push({ id: uuid(), name, balance, apr, payment });
      $("debtName").value=""; $("debtBal").value=""; $("debtApr").value=""; $("debtPay").value="";
      save(); renderAll(); toast("Debt added");
    });
    $("clearDebtInputs").addEventListener("click", ()=>{
      $("debtName").value=""; $("debtBal").value=""; $("debtApr").value=""; $("debtPay").value="";
    });

    $("extraDebt").addEventListener("input", ()=>{
      state.debtPlan.extra = Number($("extraDebt").value||0);
      save(); renderDebts(); renderDashboard(); renderPay();
    });
    $("debtStrategy").addEventListener("change", ()=>{
      state.debtPlan.strategy = $("debtStrategy").value;
      save(); renderDebts();
    });

    // Goals
    $("saveGoals").addEventListener("click", ()=>{
      state.goals.emergency = Number($("gEmergency").value||0);
      state.goals.invest = Number($("gInvest").value||0);
      state.goals.fun = Number($("gFun").value||0);
      state.goals.groceries = Number($("gGroc").value||0);
      save(); renderAll(); toast("Goals saved");
    });
    $("zeroGoals").addEventListener("click", ()=>{
      state.goals = { emergency:0, invest:0, fun:0, groceries:0 };
      save(); renderAll(); toast("Goals cleared");
    });

    // Profile
    function updateCalcTotal(){
      const base = Number($("basePay").value||0);
      const bah = Number($("bah").value||0);
      const bas = Number($("bas").value||0);
      const total = base+bah+bas;
      $("calcTotal").value = total>0 ? fmt(total) : "";
    }
    ["basePay","bah","bas"].forEach(id=>{
      $(id).addEventListener("input", updateCalcTotal);
    });

    $("saveProfile").addEventListener("click", ()=>{
      state.profile.paySchedule = $("paySchedule").value;
      state.profile.monthlyIncome = Number($("incomeMonthly").value||0);
      state.profile.rank = $("rank").value || "";
      state.profile.basePay = Number($("basePay").value||0);
      state.profile.bah = Number($("bah").value||0);
      state.profile.bas = Number($("bas").value||0);
      save(); renderAll(); toast("Profile saved");
    });

    // Rank helper (DEMO values, just for mock)
    const basePayDemo = {
      E1: 2000, E2: 2250, E3: 2500, E4: 2900,
      E5: 3300, E6: 3800, E7: 4500, E8: 5200, E9: 6000
    };
    $("applyRank").addEventListener("click", ()=>{
      const r = $("rank").value;
      if(!r){ toast("Pick a rank first"); return; }
      const base = basePayDemo[r] || 0;
      $("basePay").value = base;
      updateCalcTotal();
      toast("Base pay filled (demo)");
    });

    // Settings
    $("btnExport").addEventListener("click", ()=>{
      const data = JSON.stringify(state, null, 2);
      openModal("Export Data", `
        <div class="muted">Copy this JSON and save it. You can import it later.</div>
        <div style="height:10px"></div>
        <textarea id="exportBox" style="min-height:220px">${escapeHtml(data)}</textarea>
      `, [
        {label:"Close", kind:"secondary", onClick: closeModal},
        {label:"Copy", kind:"", onClick: ()=>{
          navigator.clipboard?.writeText(data);
          toast("Copied");
        }}
      ]);
    });

    $("btnImport").addEventListener("click", ()=>{
      openModal("Import Data", `
        <div class="muted">Paste JSON here to restore a budget.</div>
        <div style="height:10px"></div>
        <textarea id="importBox" style="min-height:220px" placeholder="Paste exported JSON..."></textarea>
      `, [
        {label:"Cancel", kind:"secondary", onClick: closeModal},
        {label:"Import", kind:"", onClick: ()=>{
          try{
            const raw = $("importBox").value.trim();
            const obj = JSON.parse(raw);
            localStorage.setItem(KEY, JSON.stringify(obj));
            toast("Imported");
            closeModal();
            location.reload();
          } catch(e){
            toast("Invalid JSON");
          }
        }}
      ]);
    });

    $("btnDemo").addEventListener("click", ()=>{
      openModal("Load Demo Data?", `
        <div class="muted">
          This will populate MilBudget with realistic example bills, debts, and goals so your friends can test quickly.
        </div>
      `, [
        {label:"Cancel", kind:"secondary", onClick: closeModal},
        {label:"Load Demo", kind:"", onClick: ()=>{
          loadDemo();
          closeModal();
          toast("Demo loaded");
        }}
      ]);
    });

    $("btnWipe").addEventListener("click", ()=>{
      openModal("Wipe Everything?", `<div class="muted"><b>This clears all stored data.</b></div>`, [
        {label:"Cancel", kind:"secondary", onClick: closeModal},
        {label:"Wipe", kind:"danger", onClick: ()=>{
          localStorage.removeItem(KEY);
          closeModal();
          toast("Wiped");
          setTimeout(()=>location.reload(), 350);
        }}
      ]);
    });

    $("btnPrint").addEventListener("click", ()=>{
      const inc = monthlyIncome();
      const b = billsTotal();
      const g = goalsTotal();
      const d = debtMonthlyTotal();
      const rem = remaining();
      const s = paydaySplit();

      const billLines = state.bills.map(x=>`‚Ä¢ ${x.name} (${labelDue(x.due)}) - ${fmt(x.amount)}`).join("\\n");
      const debtLines = state.debts.map(x=>`‚Ä¢ ${x.name} - Balance ${fmt(x.balance)}, Payment ${fmt(x.payment)}, APR ${Number(x.apr||0).toFixed(2)}%`).join("\\n");

      const text =
`MilBudget Summary
=================
Monthly income: ${fmt(inc)}
Bills total:    ${fmt(b)}
Goals total:    ${fmt(g)}
Debt payments:  ${fmt(d)}
Remaining:      ${fmt(rem)}

Payday Split (1st/15th)
----------------------
Paycheck #1 income: ${fmt(s.p1inc)} | Out: ${fmt(s.p1Out)} | Left: ${fmt(s.p1Left)}
Paycheck #2 income: ${fmt(s.p2inc)} | Out: ${fmt(s.p2Out)} | Left: ${fmt(s.p2Left)}

Bills
-----
${billLines || "(none)"}

Debts
-----
${debtLines || "(none)"}

Notes
-----
${state.notes || "(none)"}
`;
      openModal("Print Summary", `
        <div class="muted">Copy this to Notes, email, or print it.</div>
        <div style="height:10px"></div>
        <textarea style="min-height:260px">${escapeHtml(text)}</textarea>
      `, [{label:"Close", kind:"secondary", onClick: closeModal}]);
    });

    function loadDemo(){
      state.profile.paySchedule = "1st15th";
      state.profile.monthlyIncome = 4200;
      state.profile.rank = "E3";
      state.profile.basePay = 2500;
      state.profile.bah = 1600;
      state.profile.bas = 460;

      state.bills = [
        {id:uuid(), name:"Rent", amount:975, due:"1st", category:"Housing"},
        {id:uuid(), name:"Car Payment", amount:502, due:"15th", category:"Transportation"},
        {id:uuid(), name:"Car Insurance", amount:250, due:"1st", category:"Insurance"},
        {id:uuid(), name:"Phone", amount:85, due:"monthly", category:"Phone/Internet"},
        {id:uuid(), name:"Internet", amount:60, due:"monthly", category:"Utilities"},
        {id:uuid(), name:"Gym", amount:35, due:"monthly", category:"Subscriptions"},
      ];

      state.debts = [
        {id:uuid(), name:"Camry Loan", balance:8000, apr:6.00, payment:502},
        {id:uuid(), name:"Credit Card", balance:1200, apr:24.99, payment:75},
      ];
      state.debtPlan.extra = 50;
      state.debtPlan.strategy = "avalanche";

      state.goals = { emergency:200, invest:100, fun:150, groceries:350 };
      state.notes = "Demo notes: Try adjusting bills and see Payday Split update.";
      state.feedbackNotes = "";
      save();
      renderAll();
    }

    // ---- Make sure global functions exist for onclick in tables
    // (already assigned above)

    // ---- Initialize
    // Apply theme
    document.documentElement.setAttribute("data-theme", state.theme==="light" ? "light" : "dark");

    // Wire settings textareas
    $("notes").value = state.notes || "";
    $("feedbackNotes").value = state.feedbackNotes || "";

    // Default values
    $("billSort").value = "due";

    // Autosave notes already wired.

    // Initial render
    renderAll();

    // Handle resize for chart
    window.addEventListener("resize", ()=>renderPie());

    // Prevent broken pie scaling from repeated scale stacking:
    // Re-render pie by resetting transform each time inside renderPie via new context scale per render.
    // (Canvas is resized each time, so scale resets.)

  </script>
</body>
</html>
